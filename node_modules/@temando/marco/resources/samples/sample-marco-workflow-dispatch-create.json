{
  "workflow": {
    "id": "dispatchCreate",
    "title": {
      "messageKey": "dispatchCreate.titles.workflow"
    },
    "steps": [
      {
        "id": "selection",
        "title": {
          "messageKey": "dispatchCreate.titles.selection"
        },
        "type": "form",
        "form": {
          "id": "selection",
          "controlSets": [
            {
              "id": "selection",
              "controls": [
                {
                  "id": "carrier",
                  "type": "dropdown",
                  "title": {
                    "messageKey": "dispatchCreate.selection.carrier"
                  },
                  "dataSource": {
                    "trigger": {
                      "event": "onload"
                    },
                    "httpRequest": {
                      "url": "{endpoint}/carriers?filter[registered]=true",
                      "method": "GET",
                      "urlParams": [
                        {
                          "param": "endpoint",
                          "stateRef": "#/temando/apiEndpoint"
                        }
                      ],
                      "headers": [
                        {
                          "header": "Authorization",
                          "stateRef": "#/temando/apiToken",
                          "transforms": [
                            {
                              "type": "prefixString",
                              "prefix": "Bearer "
                            }
                          ]
                        },
                        {
                          "header": "Accept",
                          "value": "application/vnd.api+json"
                        },
                        {
                          "header": "Content-Type",
                          "value": "application/vnd.api+json"
                        }
                      ]
                    },
                    "transforms": [
                      {
                        "type": "getValue",
                        "ref": "#/data"
                      },
                      {
                        "type": "transformEach",
                        "transform": {
                          "type": "changeShape",
                          "values": [
                            {
                              "input": "#/attributes/name",
                              "output": "#/title"
                            },
                            {
                              "input": "#/id",
                              "output": "#/value/id"
                            },
                            {
                              "input": "#/attributes/name",
                              "output": "#/value/name"
                            }
                          ]
                        }
                      }
                    ]
                  },
                  "validation": [
                    {
                      "rule": "required",
                      "messages": {
                        "required": {
                          "messageKey": "common.validation.required"
                        }
                      }
                    }
                  ]
                },
                {
                  "id": "location",
                  "type": "dropdown",
                  "title": {
                    "messageKey": "dispatchCreate.selection.location"
                  },
                  "dataSource": {
                    "trigger": {
                      "event": "onload"
                    },
                    "httpRequest": {
                      "url": "{endpoint}/locations",
                      "method": "GET",
                      "urlParams": [
                        {
                          "param": "endpoint",
                          "stateRef": "#/temando/apiEndpoint"
                        }
                      ],
                      "headers": [
                        {
                          "header": "Authorization",
                          "stateRef": "#/temando/apiToken",
                          "transforms": [
                            {
                              "type": "prefixString",
                              "prefix": "Bearer "
                            }
                          ]
                        },
                        {
                          "header": "Accept",
                          "value": "application/vnd.api+json"
                        },
                        {
                          "header": "Content-Type",
                          "value": "application/vnd.api+json"
                        }
                      ]
                    },
                    "transforms": [
                      {
                        "type": "getValue",
                        "ref": "#/data"
                      },
                      {
                        "type": "transformEach",
                        "transform": {
                          "type": "changeShape",
                          "values": [
                            {
                              "input": "#/attributes/name",
                              "output": "#/title"
                            },
                            {
                              "input": "#/id",
                              "output": "#/value"
                            }
                          ]
                        }
                      }
                    ]
                  },
                  "validation": [
                    {
                      "rule": "required",
                      "messages": {
                        "required": {
                          "messageKey": "common.validation.required"
                        }
                      }
                    }
                  ]
                }
              ]
            }
          ],
          "httpRequest": {
            "url": "{endpoint}/shipments?limit=100000&filter=%5B%7B%22path%22:%22/originId%22,%22operator%22:%22equal%22,%22value%22:%22{originId}%22%7D,%7B%22path%22:%22/completionId%22,%22operator%22:%22exists%22,%22value%22:false%7D,%7B%22path%22:%22/fulfill/carrierBooking/integrationId%22,%22operator%22:%22equal%22,%22value%22:%22{integrationId}%22%7D%5D",
            "method": "GET",
            "urlParams": [
              {
                "param": "endpoint",
                "stateRef": "#/temando/apiEndpoint"
              },
              {
                "param": "integrationId",
                "stateRef": "#/form/selection/valuesByControlId/carrier/id"
              },
              {
                "param": "originId",
                "stateRef": "#/form/selection/valuesByControlId/location"
              }
            ],
            "headers": [
              {
                "header": "Authorization",
                "stateRef": "#/temando/apiToken",
                "transforms": [
                  {
                    "type": "prefixString",
                    "prefix": "Bearer "
                  }
                ]
              },
              {
                "header": "Accept",
                "value": "application/vnd.api+json"
              },
              {
                "header": "Content-Type",
                "value": "application/vnd.api+json"
              }
            ]
          }
        },
        "next": [
          {
            "stepId": "confirmShipments",
            "condition": {
              "leftOperand": {
                "stateRef": "#/form/selection/valuesByControlId/carrier/id"
              },
              "operator": "in",
              "rightOperand": {
                "static": ["auspost", "ups"]
              }
            }
          },
          {
            "stepId": "confirmShipments",
            "condition": {
              "or": [
                {
                  "leftOperand": {
                    "stateRef": "#/form/selection/valuesByControlId/carrier/id"
                  },
                  "operator": "equal",
                  "rightOperand": {
                    "static": "auspost"
                  }
                },
                {
                  "leftOperand": {
                    "stateRef": "#/form/selection/valuesByControlId/carrier/id"
                  },
                  "operator": "equal",
                  "rightOperand": {
                    "static": "ups"
                  }
                }
              ]
            }
          },
          {
            "stepId": "confirmShipments",
            "condition": {
              "and": [
                {
                  "leftOperand": {
                    "stateRef": "#/form/selection/valuesByControlId/carrier/id"
                  },
                  "operator": "equal",
                  "rightOperand": {
                    "static": "fedEx"
                  }
                },
                {
                  "leftOperand": {
                    "stateRef": "#/form/selection/valuesByControlId/location"
                  },
                  "operator": "equal",
                  "rightOperand": {
                    "static": 1
                  }
                }
              ]
            }
          }
        ]
      },
      {
        "id": "confirmShipments",
        "title": {
          "messageKey": "dispatchCreate.titles.confirmShipments"
        },
        "description": {
          "messageKey": "dispatchCreate.descriptions.confirmShipments"
        },
        "type": "grid",
        "grid": {
          "id": "confirmShipments",
          "rows": {
            "stateRef": "#/form/selection/responseData/data"
          },
          "columns": [
            {
              "title": {
                "messageKey": "dispatchCreate.confirmShipments.createdAt"
              },
              "ref": "#/attributes/createdAt",
              "transforms": [
                {
                  "type": "formatDate",
                  "momentFormatString": "lll"
                }
              ]
            },
            {
              "title": {
                "messageKey": "dispatchCreate.confirmShipments.destinationContact"
              },
              "ref": "#/attributes/destination/contact",
              "transforms": [
                {
                  "type": "buildString",
                  "format": "{personFirstName} {personLastName}"
                }
              ]
            },
            {
              "title": {
                "messageKey": "dispatchCreate.confirmShipments.destinationAddress"
              },
              "ref": "#/attributes/destination/address",
              "transforms": [
                {
                  "type": "formatAddress"
                }
              ]
            },
            {
              "title": {
                "messageKey": "dispatchCreate.confirmShipments.numberOfPackages"
              },
              "ref": "#/attributes/packages",
              "transforms": [
                {
                  "type": "getAttribute",
                  "attribute": "length"
                }
              ]
            },
            {
              "title": {
                "messageKey": "dispatchCreate.confirmShipments.carrierName"
              },
              "ref": "#/attributes/fulfill/carrierBooking/carrierName"
            },
            {
              "title": {
                "messageKey": "dispatchCreate.confirmShipments.serviceName"
              },
              "ref": "#/attributes/fulfill/carrierBooking/serviceName"
            },
            {
              "title": {
                "messageKey": "dispatchCreate.confirmShipments.shippingTaxInclusiveCharge"
              },
              "ref": "#/attributes/fulfill/carrierBooking/shippingTaxInclusiveCharge",
              "transforms": [
                {
                  "type": "changeShape",
                  "values": [
                    {
                      "input": "#/amount",
                      "output": "#/value"
                    },
                    {
                      "input": "#/currency",
                      "output": "#/currency"
                    }
                  ]
                },
                {
                  "type": "formatCurrency"
                }
              ]
            }
          ],
          "rowActions": [
            {
              "action": "view",
              "url": {
                "stateRef": "#/custom/viewShipmentUrlTpl"
              },
              "urlParams": [
                {
                  "param": "id",
                  "ref": "#/id"
                }
              ]
            }
          ],
          "selectedValueRef": "#/id",
          "defaultSelection": "all"
        },
        "next": [
          {
            "stepId": "dispatch"
          }
        ]
      },
      {
        "id": "dispatch",
        "title": {
          "messageKey": "dispatchCreate.titles.dispatch"
        },
        "type": "form",
        "form": {
          "id": "dispatch",
          "controlSets": [
            {
              "id": "dispatch",
              "controls": [
                {
                  "id": "numberOfShipments",
                  "type": "infoText",
                  "title": {
                    "messageKey": "dispatchCreate.dispatch.numberOfShipments"
                  },
                  "defaultValue": {
                    "stateRef": "#/grid/confirmShipments/selection",
                    "transforms": [
                      {
                        "type": "getAttribute",
                        "attribute": "length"
                      }
                    ]
                  },
                  "validation": [
                    {
                      "rule": "number",
                      "greaterThan": 0,
                      "messages": {
                        "greaterThan": {
                          "messageKey": "dispatchCreate.validation.noShipments"
                        }
                      }
                    }
                  ]
                },
                {
                  "id": "readyAt",
                  "ref": "#/data/attributes/readyAt",
                  "type": "datetime",
                  "title": {
                    "messageKey": "dispatchCreate.dispatch.readyAt"
                  },
                  "defaultValue": {
                    "generate": "dateNow"
                  },
                  "validation": [
                    {
                      "rule": "required",
                      "messages": {
                        "required": {
                          "messageKey": "common.validation.required"
                        }
                      }
                    }
                  ]
                },
                {
                  "id": "documentationFormat",
                  "type": "dropdown",
                  "title": {
                    "messageKey": "dispatchCreate.dispatch.documentationFormat"
                  },
                  "options": [
                    {
                      "title": {
                        "messageKey": "dispatchCreate.dispatch.formats.pdf"
                      },
                      "value": "PDF"
                    }
                  ]
                }
              ]
            }
          ],
          "httpRequest": {
            "url": "{endpoint}/completions",
            "method": "POST",
            "urlParams": [
              {
                "param": "endpoint",
                "stateRef": "#/temando/apiEndpoint"
              }
            ],
            "headers": [
              {
                "header": "Authorization",
                "stateRef": "#/temando/apiToken",
                "transforms": [
                  {
                    "type": "prefixString",
                    "prefix": "Bearer "
                  }
                ]
              },
              {
                "header": "Accept",
                "value": "application/vnd.api+json"
              },
              {
                "header": "Content-Type",
                "value": "application/vnd.api+json"
              }
            ],
            "requestData": [
              {
                "ref": "#/data/type",
                "value": "completion"
              },
              {
                "ref": "#/data/attributes/customAttributes/carrierName",
                "stateRef": "#/form/selection/valuesByControlId/carrier/name"
              },
              {
                "ref": "#/data/attributes/shipments",
                "stateRef": "#/grid/confirmShipments/selection"
              }
            ]
          }
        },
        "next": [
          {
            "done": true
          }
        ]
      }
    ]
  },
  "included": {
    "messages": {
      "dispatchCreate.titles.workflow": "New Dispatch",
      "dispatchCreate.titles.selection": "Carrier and Location Selection",
      "dispatchCreate.titles.confirmShipments": "Confirm Shipments",
      "dispatchCreate.titles.dispatch": "Dispatch",
      "dispatchCreate.descriptions.confirmShipments": "These are shipments for the chosen carrier and location which haven't yet been dispatched. You may adjust this selection.",
      "dispatchCreate.validation.noShipments": "At least one shipment must be selected to dispatch.",
      "dispatchCreate.selection.carrier": "Carrier",
      "dispatchCreate.selection.location": "Location",
      "dispatchCreate.confirmShipments.createdAt": "Create Date",
      "dispatchCreate.confirmShipments.destinationContact": "Destination Contact",
      "dispatchCreate.confirmShipments.destinationAddress": "Destination Address",
      "dispatchCreate.confirmShipments.numberOfPackages": "Number of Packages",
      "dispatchCreate.confirmShipments.carrierName": "Carrier",
      "dispatchCreate.confirmShipments.serviceName": "Service",
      "dispatchCreate.confirmShipments.shippingTaxInclusiveCharge": "Shipping Charge (Tax Incl.)",
      "dispatchCreate.dispatch.numberOfShipments": "Number of Shipments",
      "dispatchCreate.dispatch.readyAt": "Ready At",
      "dispatchCreate.dispatch.documentationFormat": "Documentation Format",
      "dispatchCreate.dispatch.formats.pdf": "PDF"
    }
  }
}
