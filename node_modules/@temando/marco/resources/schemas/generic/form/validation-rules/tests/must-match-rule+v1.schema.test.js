const Ajv = require('ajv');
const chai = require('chai');
chai.use(require('dirty-chai'));
const expect = chai.expect;

const messageV1Schema = require('../../../message+v1.schema.json');
const mustMatchValidationSchema =
  require('../must-match-rule+v1.schema.json');

const ajv = new Ajv();

ajv.addSchema(messageV1Schema);
ajv.addSchema(mustMatchValidationSchema, 'mustMatchValidation');

describe('Testing must match validation schema', function() {
  it('should be valid when having all fields defined', function() {
    const isValid = ajv.validate('mustMatchValidation', {
      "rule": "mustMatch",
      "matchControlId": "password",
      "messages": {
        "notMatching": {
          "messageKey": "form.common.password.mustMatch"
        }
      }
    });

    if (!isValid) console.error(ajv.errors);

    expect(isValid).to.be.ok();
  });

  it('should be invalid when having additional properties', function() {
    const isValid = ajv.validate('mustMatchValidation', {
      "rule": "mustMatch",
      "matchControlId": "password",
      "shouldFail": "becauseOfThisProperty",
      "messages": {
        "notMatching": {
          "messageKey": "form.common.password.mustMatch"
        }
      }
    });

    const expectedError = 'should NOT have additional properties';
    if (isValid) throw new Error(`Error it should fail with ${expectedError}`);

    expect(ajv.errors[0].message).to.be.equal(expectedError);
  });

  it('should be invalid when having additional properties in messages', function() {
    const isValid = ajv.validate('mustMatchValidation', {
      "rule": "mustMatch",
      "matchControlId": "password",
      "messages": {
        "shouldFail": "becauseOfThisProperty",
        "notMatching": {
          "messageKey": "form.common.password.mustMatch"
        }
      }
    });

    const expectedError = 'should NOT have additional properties';
    if (isValid) throw new Error(`Error it should fail with ${expectedError}`);

    expect(ajv.errors[0].message).to.be.equal(expectedError);
  });
});
