# Serverless Temando Registry Plugin

A Serverless plugin that updates a Service Registry with deployment information for the service being deployed.

## Prerequisites

- Either:
  - `>= serverless@1.3`
  - `serverless@0.5`
- A Service Registry enabled project (`ts-definition.json`).
- A `serverless.env.yml` file (empty is fine) when using `serverless@1`

## Installation

- `npm install --save-dev @temando/serverless-temando-registry`
- Add `@temando/serverless-temando-registry` to the `plugins` in the Serverless config file.


## Usage

```sh
serverless registry update
```

This will default to using the default stage or region if there are no others set in your project, and prompt you if there are additional options.

### Optional parameters

For headless deployments, it's recommended to be explicit by specifiying the following parameters:

- `-s, --stage`: Name of the API Gateway stage you wish to update the registry from (optional)
- `-r, --region`: Name of the API Gateway region you wish to update the registry from (optional)
- `-v, --version`: The version of the deployed project (optional)

### Custom options

You can specify a custom path for your `ts-definition.json` file in `s-project.json` by adding a section under the custom object.

e.g.

```javascript
{
  "custom": {
    "temandoRegistry": {
      "serviceDefinition": "path/to/my-definition-file.json"
    }
  }
}
```

### Example Service Definition

If your project is deploying SQS Queues `ts-definition.json` file could look like below.

In this example `${dhlTestQueueUrl}` placeholder, will be replaced with the AWS CloudFormation Outputs that correspond to the name of that variable as defined in your `s-resources-cf.json` in your Serverless project.

Sample `ts-definition.json`:

```javascript
{
  "$schema": "http://services.temando.com/schema/service-definition+v1#",
  "id": "temando-integration-dhl-express-v1",
  "dependencies": [
    "temando-instrumentation-gateway",
    "temando-document-storage",
    "temando-packing-optimisation",
    "test"
  ],
  "publicQueues": [
    {
      "id": "dhltest-queue",
      "url": "${dhlTestQueueUrl}"
    }
  ]
}
```

Sample `s-resources-cf.json` (only relevant parts):

```javascript
{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "The AWS CloudFormation template for this Serverless application's resources outside of Lambdas and Api Gateway",
  "Resources": {
    /*... other resources */
    "DHLTestQueue": {
      "Type": "AWS::SQS::Queue",
      "Properties": {
        "QueueName": "projectname-stagename-dhltest-queue",
        "DelaySeconds": 0,
        "MessageRetentionPeriod": 345600,
        "VisibilityTimeout": 30,
        "ReceiveMessageWaitTimeSeconds": 1,
        "MaximumMessageSize": 262144
      }
    }
  },
  "Outputs": {
    /*... other outputs */
    "dhlTestQueueUrl": {
      "Description": "URL of the source queue",
      "Value": {
        "Ref": "DHLTestQueue"
      }
    }
  }
}
```
