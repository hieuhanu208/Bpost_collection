'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _getIterator2 = require('babel-runtime/core-js/get-iterator');

var _getIterator3 = _interopRequireDefault(_getIterator2);

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

exports.default = function (S) {
  // eslint-disable-next-line global-require, import/no-dynamic-require
  var SCli = require(S.getServerlessPath('utils/cli'));

  // eslint-disable-next-line no-extend-native
  String.prototype.lowercaseFirst = function lowercaseFirst() {
    return this.charAt(0).toLowerCase() + this.slice(1);
  };

  var PluginTemandoServiceRegistry = function (_S$classes$Plugin) {
    (0, _inherits3.default)(PluginTemandoServiceRegistry, _S$classes$Plugin);

    function PluginTemandoServiceRegistry() {
      (0, _classCallCheck3.default)(this, PluginTemandoServiceRegistry);

      var _this = (0, _possibleConstructorReturn3.default)(this, (PluginTemandoServiceRegistry.__proto__ || (0, _getPrototypeOf2.default)(PluginTemandoServiceRegistry)).call(this));

      _this.name = 'TemandoServiceRegistry';
      return _this;
    }

    (0, _createClass3.default)(PluginTemandoServiceRegistry, [{
      key: 'registerActions',
      value: function registerActions() {
        S.addAction(this.updateRegistry.bind(this), {
          handler: 'registryUpdate',
          description: 'Update the Temando Registry',
          context: 'registry',
          contextAction: 'update',
          options: [{
            option: 'stage',
            shortcut: 's',
            description: 'Optional if only one stage is defined in project'
          }, {
            option: 'region',
            shortcut: 'r',
            description: 'Target one region to deploy to'
          }, {
            option: 'version',
            shortcut: 'v',
            description: 'The version being deployment'
          }],
          parameters: []
        });
      }
    }, {
      key: 'registerHooks',
      value: function registerHooks() {
        S.addHook(this.postResourceDeploy.bind(this), {
          action: 'resourcesDeploy',
          event: 'post'
        });
      }
    }, {
      key: 'updateRegistry',
      value: function () {
        var _ref = (0, _bluebird.coroutine)(_regenerator2.default.mark(function _callee(e) {
          return _regenerator2.default.wrap(function _callee$(_context) {
            while (1) {
              switch (_context.prev = _context.next) {
                case 0:
                  if (!(!S.config.interactive || e.options.stage && e.options.region)) {
                    _context.next = 2;
                    break;
                  }

                  return _context.abrupt('return', this.startRegistryUpdate(e));

                case 2:
                  _context.next = 4;
                  return this.cliPromptSelectStage('Which stage are you updating: ', e.options.stage, false);

                case 4:
                  e.options.stage = _context.sent;
                  _context.next = 7;
                  return this.cliPromptSelectRegion('Which region are you updating: ', false, true, e.options.region, e.options.stage);

                case 7:
                  e.options.region = _context.sent;
                  return _context.abrupt('return', this.startRegistryUpdate(e));

                case 9:
                case 'end':
                  return _context.stop();
              }
            }
          }, _callee, this);
        }));

        function updateRegistry(_x) {
          return _ref.apply(this, arguments);
        }

        return updateRegistry;
      }()
    }, {
      key: 'postResourceDeploy',
      value: function () {
        var _ref2 = (0, _bluebird.coroutine)(_regenerator2.default.mark(function _callee2(e) {
          return _regenerator2.default.wrap(function _callee2$(_context2) {
            while (1) {
              switch (_context2.prev = _context2.next) {
                case 0:
                  if (!(!S.config.interactive || e.options.stage && e.options.region)) {
                    _context2.next = 2;
                    break;
                  }

                  return _context2.abrupt('return', this.setVariablesFromOutput(e));

                case 2:
                  _context2.next = 4;
                  return this.cliPromptSelectStage('Which stage are you updating: ', e.options.stage, false);

                case 4:
                  e.options.stage = _context2.sent;
                  _context2.next = 7;
                  return this.cliPromptSelectRegion('Which region are you updating: ', false, true, e.options.region, e.options.stage);

                case 7:
                  e.options.region = _context2.sent;
                  return _context2.abrupt('return', this.setVariablesFromOutput(e));

                case 9:
                case 'end':
                  return _context2.stop();
              }
            }
          }, _callee2, this);
        }));

        function postResourceDeploy(_x2) {
          return _ref2.apply(this, arguments);
        }

        return postResourceDeploy;
      }()
    }, {
      key: 'setVariablesFromOutput',
      value: function () {
        var _ref3 = (0, _bluebird.coroutine)(_regenerator2.default.mark(function _callee4(e) {
          var _this2 = this;

          var settings, cf, result, stack, sProject, events, streamEvents, awsLambda, awsAccountId;
          return _regenerator2.default.wrap(function _callee4$(_context4) {
            while (1) {
              switch (_context4.prev = _context4.next) {
                case 0:
                  SCli.log('Set serverless variables from CloudFormation Outputs....');

                  // eslint-disable-next-line no-underscore-dangle
                  settings = S._project.getVariablesObject(e.options.stage, e.options.region);
                  cf = _bluebird2.default.promisifyAll(new _awsSdk2.default.CloudFormation({
                    region: settings.region
                  }));
                  _context4.next = 5;
                  return cf.describeStacksAsync({
                    StackName: settings.resourcesStackName || `${settings.project}-${settings.stage}-r`
                  });

                case 5:
                  result = _context4.sent;

                  if (!(result.Stacks.length < 1)) {
                    _context4.next = 8;
                    break;
                  }

                  throw new Error('Could not get CloudFormation stack information - ' + 'unable to set serverless variables');

                case 8:
                  stack = result.Stacks.pop();

                  // eslint-disable-next-line no-underscore-dangle

                  sProject = S._project.getRegion(e.options.stage, e.options.region);


                  if (Array.isArray(stack.Outputs)) {
                    stack.Outputs.forEach(function (output) {
                      var outputVar = {};
                      var key = output.OutputKey.lowercaseFirst();
                      outputVar[key] = output.OutputValue;

                      sProject.addVariables(outputVar);
                      SCli.log(`Set serverless variables "${key}" to "${outputVar[key]}"`);
                    });
                    sProject.save();
                    SCli.log('Successfully set variable(s) from outputs.');
                  } else {
                    SCli.log('CloudFormation has no Output.');
                  }

                  // eslint-disable-next-line no-underscore-dangle
                  events = S._project.getAllEvents();

                  if (!Array.isArray(events)) {
                    _context4.next = 24;
                    break;
                  }

                  streamEvents = events.filter(function (event) {
                    return event.type === 'dynamodbstream' || event.type === 'kinesisstream';
                  });

                  if (!(streamEvents.length === 0)) {
                    _context4.next = 18;
                    break;
                  }

                  SCli.log('No events with type: dynamodbstream, kinesisstream.');
                  _context4.next = 24;
                  break;

                case 18:
                  awsLambda = _bluebird2.default.promisifyAll(new _awsSdk2.default.Lambda({
                    region: settings.region
                  }), { suffix: 'Asynced' });
                  awsAccountId = S.getProvider().getAccountId(settings.stage, settings.region);
                  _context4.next = 22;
                  return _bluebird2.default.all(streamEvents.map(function () {
                    var _ref4 = (0, _bluebird.coroutine)(_regenerator2.default.mark(function _callee3(event) {
                      var populated, functionArn, eventMapping, eventVar, eventDetail, key;
                      return _regenerator2.default.wrap(function _callee3$(_context3) {
                        while (1) {
                          switch (_context3.prev = _context3.next) {
                            case 0:
                              // Get Event Details
                              populated = event.toObjectPopulated(settings);
                              // eslint-disable-next-line max-len

                              functionArn = `arn:aws:lambda:${settings.region}:${awsAccountId}:function:${settings.project}-${event.getFunction().name}:${settings.stage}`;
                              _context3.next = 4;
                              return awsLambda.listEventSourceMappingsAsynced({
                                FunctionName: functionArn,
                                EventSourceArn: populated.config.streamArn,
                                // With assumption that each function only subscribe to the same stream once
                                MaxItems: 1
                              });

                            case 4:
                              eventMapping = _context3.sent;
                              eventVar = {};

                              // Set variable using first result if exist

                              if (typeof eventMapping !== 'undefined' && Array.isArray(eventMapping.EventSourceMappings) && eventMapping.EventSourceMappings.length > 0) {
                                eventDetail = eventMapping.EventSourceMappings[0];
                                key = `eventID:${populated.name}`;


                                eventVar[key] = eventDetail.UUID;
                                sProject.addVariables(eventVar);
                                SCli.log(`Set serverless variables "${key}" to "${eventVar[key]}"`);
                              }

                              return _context3.abrupt('return', eventVar);

                            case 8:
                            case 'end':
                              return _context3.stop();
                          }
                        }
                      }, _callee3, _this2);
                    }));

                    return function (_x4) {
                      return _ref4.apply(this, arguments);
                    };
                  }()));

                case 22:
                  sProject.save();
                  SCli.log('Successfully set variable(s) from stream events.');

                case 24:
                  return _context4.abrupt('return', e);

                case 25:
                case 'end':
                  return _context4.stop();
              }
            }
          }, _callee4, this);
        }));

        function setVariablesFromOutput(_x3) {
          return _ref3.apply(this, arguments);
        }

        return setVariablesFromOutput;
      }()
    }, {
      key: 'getServiceDefinitionPath',
      value: function getServiceDefinitionPath() {
        // Get projectPath
        var projectPath = S.config.projectPath;

        // Check if ts-definition.json exists or whether there's an alternative config
        var cust = S.getProject().custom;
        var configPath = void 0;

        try {
          _fs2.default.accessSync(`${projectPath}/ts-definition.json`, _fs2.default.R_OK);
          configPath = `${projectPath}/ts-definition.json`;
        } catch (e) {
          configPath = false;
        }

        if (!configPath && cust && cust.temandoRegistry && cust.temandoRegistry.serviceDefinition) {
          try {
            _fs2.default.accessSync(`${projectPath}/${cust.temandoRegistry.serviceDefinition}`, _fs2.default.R_OK);
            configPath = `${projectPath}/${cust.temandoRegistry.serviceDefinition}`;
          } catch (e) {
            configPath = false;
          }
        }

        if (!configPath) {
          return false;
        }

        return configPath;
      }
    }, {
      key: 'startRegistryUpdate',
      value: function () {
        var _ref5 = (0, _bluebird.coroutine)(_regenerator2.default.mark(function _callee5(e) {
          var definitionPath, settings, provider, apiGateway, endpoint, cf, result, stack, r, serviceDefinition, cfVars, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, output, interpolator, updatedDefinition, deployment;

          return _regenerator2.default.wrap(function _callee5$(_context5) {
            while (1) {
              switch (_context5.prev = _context5.next) {
                case 0:
                  SCli.log('startRegistryUpdate');
                  definitionPath = this.getServiceDefinitionPath();
                  // console.log(definitionPath);

                  if (definitionPath) {
                    _context5.next = 5;
                    break;
                  }

                  SCli.log('Skipping Temando Service Registry update - no service definition found');
                  return _context5.abrupt('return', e);

                case 5:

                  /* eslint-disable no-underscore-dangle*/
                  settings = S._project.getVariablesObject(e.options.stage, e.options.region);
                  /* eslint-enable no-underscore-dangle */

                  // Get API Gateway details

                  provider = S.getProvider('aws');
                  _context5.next = 9;
                  return provider.getApiByName(settings.project, e.options.stage, e.options.region);

                case 9:
                  apiGateway = _context5.sent;


                  // Build endpoint uri
                  endpoint = `https://${apiGateway.id}.execute-api.${e.options.region}.amazonaws.com/${e.options.stage}`;
                  cf = _bluebird2.default.promisifyAll(new _awsSdk2.default.CloudFormation({
                    region: settings.region
                  }));
                  _context5.next = 14;
                  return cf.describeStacksAsync({
                    StackName: settings.resourcesStackName || `${settings.project}-${settings.stage}-r`
                  });

                case 14:
                  result = _context5.sent;

                  if (!(result.Stacks.length < 1)) {
                    _context5.next = 17;
                    break;
                  }

                  throw new Error('Could not get CloudFormation stack information - ' + 'unable to update service registry');

                case 17:
                  stack = result.Stacks.pop();
                  r = new _serviceRegistryLib.Registry(settings.stage, 's3');
                  serviceDefinition = (0, _stringify2.default)(r.sm().loadDefinitionFile(definitionPath));
                  // console.log(serviceDefinition);

                  cfVars = {};

                  // eslint-disable-next-line no-restricted-syntax

                  _iteratorNormalCompletion = true;
                  _didIteratorError = false;
                  _iteratorError = undefined;
                  _context5.prev = 24;
                  for (_iterator = (0, _getIterator3.default)(stack.Outputs); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                    output = _step.value;

                    cfVars[output.OutputKey] = output.OutputValue;
                  }

                  // console.log(cfVars);

                  _context5.next = 32;
                  break;

                case 28:
                  _context5.prev = 28;
                  _context5.t0 = _context5['catch'](24);
                  _didIteratorError = true;
                  _iteratorError = _context5.t0;

                case 32:
                  _context5.prev = 32;
                  _context5.prev = 33;

                  if (!_iteratorNormalCompletion && _iterator.return) {
                    _iterator.return();
                  }

                case 35:
                  _context5.prev = 35;

                  if (!_didIteratorError) {
                    _context5.next = 38;
                    break;
                  }

                  throw _iteratorError;

                case 38:
                  return _context5.finish(35);

                case 39:
                  return _context5.finish(32);

                case 40:
                  interpolator = new _transInterpolator2.default(cfVars, { open: '${', close: '}' });
                  updatedDefinition = JSON.parse(interpolator.interpolate(serviceDefinition));

                  // Build Deployment payload

                  deployment = {
                    region: e.options.region,
                    endpoint,
                    queues: updatedDefinition.publicQueues,
                    at: new Date().toISOString()
                  };


                  if (e.options.version) {
                    deployment.version = e.options.version;
                  }

                  SCli.log(`Updating Temando Service Registry ${updatedDefinition.id}`);
                  SCli.log(`Deployment Payload: ${(0, _stringify2.default)(deployment)}`);
                  _context5.next = 48;
                  return r.catalog().putDeployment(updatedDefinition.id, deployment);

                case 48:
                  SCli.log('Temando Service Registry updated successfully!');

                  return _context5.abrupt('return', e);

                case 50:
                case 'end':
                  return _context5.stop();
              }
            }
          }, _callee5, this, [[24, 28, 32, 40], [33,, 35, 39]]);
        }));

        function startRegistryUpdate(_x5) {
          return _ref5.apply(this, arguments);
        }

        return startRegistryUpdate;
      }()
    }]);
    return PluginTemandoServiceRegistry;
  }(S.classes.Plugin);

  return PluginTemandoServiceRegistry;
};

require('babel-polyfill');

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _awsSdk = require('aws-sdk');

var _awsSdk2 = _interopRequireDefault(_awsSdk);

var _transInterpolator = require('trans-interpolator');

var _transInterpolator2 = _interopRequireDefault(_transInterpolator);

var _serviceRegistryLib = require('@temando/service-registry-lib');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9UZW1hbmRvU2VydmljZVJlZ2lzdHJ5LTAuNS5qcyJdLCJuYW1lcyI6WyJTIiwiU0NsaSIsInJlcXVpcmUiLCJnZXRTZXJ2ZXJsZXNzUGF0aCIsIlN0cmluZyIsInByb3RvdHlwZSIsImxvd2VyY2FzZUZpcnN0IiwiY2hhckF0IiwidG9Mb3dlckNhc2UiLCJzbGljZSIsIlBsdWdpblRlbWFuZG9TZXJ2aWNlUmVnaXN0cnkiLCJuYW1lIiwiYWRkQWN0aW9uIiwidXBkYXRlUmVnaXN0cnkiLCJiaW5kIiwiaGFuZGxlciIsImRlc2NyaXB0aW9uIiwiY29udGV4dCIsImNvbnRleHRBY3Rpb24iLCJvcHRpb25zIiwib3B0aW9uIiwic2hvcnRjdXQiLCJwYXJhbWV0ZXJzIiwiYWRkSG9vayIsInBvc3RSZXNvdXJjZURlcGxveSIsImFjdGlvbiIsImV2ZW50IiwiZSIsImNvbmZpZyIsImludGVyYWN0aXZlIiwic3RhZ2UiLCJyZWdpb24iLCJzdGFydFJlZ2lzdHJ5VXBkYXRlIiwiY2xpUHJvbXB0U2VsZWN0U3RhZ2UiLCJjbGlQcm9tcHRTZWxlY3RSZWdpb24iLCJzZXRWYXJpYWJsZXNGcm9tT3V0cHV0IiwibG9nIiwic2V0dGluZ3MiLCJfcHJvamVjdCIsImdldFZhcmlhYmxlc09iamVjdCIsImNmIiwicHJvbWlzaWZ5QWxsIiwiQ2xvdWRGb3JtYXRpb24iLCJkZXNjcmliZVN0YWNrc0FzeW5jIiwiU3RhY2tOYW1lIiwicmVzb3VyY2VzU3RhY2tOYW1lIiwicHJvamVjdCIsInJlc3VsdCIsIlN0YWNrcyIsImxlbmd0aCIsIkVycm9yIiwic3RhY2siLCJwb3AiLCJzUHJvamVjdCIsImdldFJlZ2lvbiIsIkFycmF5IiwiaXNBcnJheSIsIk91dHB1dHMiLCJmb3JFYWNoIiwib3V0cHV0Iiwib3V0cHV0VmFyIiwia2V5IiwiT3V0cHV0S2V5IiwiT3V0cHV0VmFsdWUiLCJhZGRWYXJpYWJsZXMiLCJzYXZlIiwiZXZlbnRzIiwiZ2V0QWxsRXZlbnRzIiwic3RyZWFtRXZlbnRzIiwiZmlsdGVyIiwidHlwZSIsImF3c0xhbWJkYSIsIkxhbWJkYSIsInN1ZmZpeCIsImF3c0FjY291bnRJZCIsImdldFByb3ZpZGVyIiwiZ2V0QWNjb3VudElkIiwiYWxsIiwibWFwIiwicG9wdWxhdGVkIiwidG9PYmplY3RQb3B1bGF0ZWQiLCJmdW5jdGlvbkFybiIsImdldEZ1bmN0aW9uIiwibGlzdEV2ZW50U291cmNlTWFwcGluZ3NBc3luY2VkIiwiRnVuY3Rpb25OYW1lIiwiRXZlbnRTb3VyY2VBcm4iLCJzdHJlYW1Bcm4iLCJNYXhJdGVtcyIsImV2ZW50TWFwcGluZyIsImV2ZW50VmFyIiwiRXZlbnRTb3VyY2VNYXBwaW5ncyIsImV2ZW50RGV0YWlsIiwiVVVJRCIsInByb2plY3RQYXRoIiwiY3VzdCIsImdldFByb2plY3QiLCJjdXN0b20iLCJjb25maWdQYXRoIiwiYWNjZXNzU3luYyIsIlJfT0siLCJ0ZW1hbmRvUmVnaXN0cnkiLCJzZXJ2aWNlRGVmaW5pdGlvbiIsImRlZmluaXRpb25QYXRoIiwiZ2V0U2VydmljZURlZmluaXRpb25QYXRoIiwicHJvdmlkZXIiLCJnZXRBcGlCeU5hbWUiLCJhcGlHYXRld2F5IiwiZW5kcG9pbnQiLCJpZCIsInIiLCJzbSIsImxvYWREZWZpbml0aW9uRmlsZSIsImNmVmFycyIsImludGVycG9sYXRvciIsIm9wZW4iLCJjbG9zZSIsInVwZGF0ZWREZWZpbml0aW9uIiwiSlNPTiIsInBhcnNlIiwiaW50ZXJwb2xhdGUiLCJkZXBsb3ltZW50IiwicXVldWVzIiwicHVibGljUXVldWVzIiwiYXQiLCJEYXRlIiwidG9JU09TdHJpbmciLCJ2ZXJzaW9uIiwiY2F0YWxvZyIsInB1dERlcGxveW1lbnQiLCJjbGFzc2VzIiwiUGx1Z2luIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7a0JBT2UsVUFBVUEsQ0FBVixFQUFhO0FBQzFCO0FBQ0EsTUFBTUMsT0FBT0MsUUFBUUYsRUFBRUcsaUJBQUYsQ0FB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QTlCLENBN1FDO0FBK1FoQkMsbUNBL1FnQixHQStRSUMsS0FBS0MsS0FBTCxDQUFXTCxhQUFhTSxXQUFiLENBQXlCbEIsaUJBQXpCLENBQVgsQ0EvUUo7O0FBaVJ0Qjs7QUFDTW1CLDRCQWxSZ0IsR0FrUkg7QUFDakJ6Riw0QkFBUUosRUFBRVIsT0FBRixDQUFVWSxNQUREO0FBRWpCNEUsNEJBRmlCO0FBR2pCYyw0QkFBUUwsa0JBQWtCTSxZQUhUO0FBSWpCQyx3QkFBSSxJQUFJQyxJQUFKLEdBQVdDLFdBQVg7QUFKYSxtQkFsUkc7OztBQXlSdEIsc0JBQUlsRyxFQUFFUixPQUFGLENBQVUyRyxPQUFkLEVBQXVCO0FBQ3JCTiwrQkFBV00sT0FBWCxHQUFxQm5HLEVBQUVSLE9BQUYsQ0FBVTJHLE9BQS9CO0FBQ0Q7O0FBRUQ3SCx1QkFBS21DLEdBQUwsQ0FBVSxxQ0FBb0NnRixrQkFBa0JSLEVBQUcsRUFBbkU7QUFDQTNHLHVCQUFLbUMsR0FBTCxDQUFVLHVCQUFzQix5QkFBZW9GLFVBQWYsQ0FBMkIsRUFBM0Q7QUE5UnNCO0FBQUEseUJBK1JoQlgsRUFBRWtCLE9BQUYsR0FBWUMsYUFBWixDQUEwQlosa0JBQWtCUixFQUE1QyxFQUFnRFksVUFBaEQsQ0EvUmdCOztBQUFBO0FBZ1N0QnZILHVCQUFLbUMsR0FBTCxDQUFTLGdEQUFUOztBQWhTc0Isb0RBa1NmVCxDQWxTZTs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTs7QUFBQTtBQUFBO0FBQUE7O0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSxJQVNpQjNCLEVBQUVpSSxPQUFGLENBQVVDLE1BVDNCOztBQXNTMUIsU0FBT3hILDRCQUFQO0FBQ0QsQzs7QUE5U0Q7O0FBQ0E7Ozs7QUFFQTs7OztBQUNBOzs7O0FBQ0EiLCJmaWxlIjoiVGVtYW5kb1NlcnZpY2VSZWdpc3RyeS0wLjUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgJ2JhYmVsLXBvbHlmaWxsJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgUHJvbWlzZSBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgQVdTIGZyb20gJ2F3cy1zZGsnO1xuaW1wb3J0IFRyYW5zSW50ZXJwb2xhdG9yIGZyb20gJ3RyYW5zLWludGVycG9sYXRvcic7XG5pbXBvcnQgeyBSZWdpc3RyeSBhcyBTZXJ2aWNlUmVnaXN0cnkgfSBmcm9tICdAdGVtYW5kby9zZXJ2aWNlLXJlZ2lzdHJ5LWxpYic7XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIChTKSB7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBnbG9iYWwtcmVxdWlyZSwgaW1wb3J0L25vLWR5bmFtaWMtcmVxdWlyZVxuICBjb25zdCBTQ2xpID0gcmVxdWlyZShTLmdldFNlcnZlcmxlc3NQYXRoKCd1dGlscy9jbGknKSk7XG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWV4dGVuZC1uYXRpdmVcbiAgU3RyaW5nLnByb3RvdHlwZS5sb3dlcmNhc2VGaXJzdCA9IGZ1bmN0aW9uIGxvd2VyY2FzZUZpcnN0KCkge1xuICAgIHJldHVybiB0aGlzLmNoYXJBdCgwKS50b0xvd2VyQ2FzZSgpICsgdGhpcy5zbGljZSgxKTtcbiAgfTtcblxuICBjbGFzcyBQbHVnaW5UZW1hbmRvU2VydmljZVJlZ2lzdHJ5IGV4dGVuZHMgUy5jbGFzc2VzLlBsdWdpbiB7XG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICBzdXBlcigpO1xuICAgICAgdGhpcy5uYW1lID0gJ1RlbWFuZG9TZXJ2aWNlUmVnaXN0cnknO1xuICAgIH1cblxuICAgIHJlZ2lzdGVyQWN0aW9ucygpIHtcbiAgICAgIFMuYWRkQWN0aW9uKHRoaXMudXBkYXRlUmVnaXN0cnkuYmluZCh0aGlzKSwge1xuICAgICAgICBoYW5kbGVyOiAncmVnaXN0cnlVcGRhdGUnLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ1VwZGF0ZSB0aGUgVGVtYW5kbyBSZWdpc3RyeScsXG4gICAgICAgIGNvbnRleHQ6ICdyZWdpc3RyeScsXG4gICAgICAgIGNvbnRleHRBY3Rpb246ICd1cGRhdGUnLFxuICAgICAgICBvcHRpb25zOiBbe1xuICAgICAgICAgIG9wdGlvbjogJ3N0YWdlJyxcbiAgICAgICAgICBzaG9ydGN1dDogJ3MnLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiAnT3B0aW9uYWwgaWYgb25seSBvbmUgc3RhZ2UgaXMgZGVmaW5lZCBpbiBwcm9qZWN0JyxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIG9wdGlvbjogJ3JlZ2lvbicsXG4gICAgICAgICAgc2hvcnRjdXQ6ICdyJyxcbiAgICAgICAgICBkZXNjcmlwdGlvbjogJ1RhcmdldCBvbmUgcmVnaW9uIHRvIGRlcGxveSB0bycsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBvcHRpb246ICd2ZXJzaW9uJyxcbiAgICAgICAgICBzaG9ydGN1dDogJ3YnLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiAnVGhlIHZlcnNpb24gYmVpbmcgZGVwbG95bWVudCcsXG4gICAgICAgIH1dLFxuICAgICAgICBwYXJhbWV0ZXJzOiBbXSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJlZ2lzdGVySG9va3MoKSB7XG4gICAgICBTLmFkZEhvb2sodGhpcy5wb3N0UmVzb3VyY2VEZXBsb3kuYmluZCh0aGlzKSwge1xuICAgICAgICBhY3Rpb246ICdyZXNvdXJjZXNEZXBsb3knLFxuICAgICAgICBldmVudDogJ3Bvc3QnLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgdXBkYXRlUmVnaXN0cnkoZSkge1xuICAgICAgaWYgKCFTLmNvbmZpZy5pbnRlcmFjdGl2ZSB8fCAoZS5vcHRpb25zLnN0YWdlICYmIGUub3B0aW9ucy5yZWdpb24pKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXJ0UmVnaXN0cnlVcGRhdGUoZSk7XG4gICAgICB9XG5cbiAgICAgIGUub3B0aW9ucy5zdGFnZSA9IGF3YWl0IHRoaXMuY2xpUHJvbXB0U2VsZWN0U3RhZ2UoXG4gICAgICAgICdXaGljaCBzdGFnZSBhcmUgeW91IHVwZGF0aW5nOiAnLFxuICAgICAgICBlLm9wdGlvbnMuc3RhZ2UsXG4gICAgICAgIGZhbHNlLFxuICAgICAgKTtcblxuICAgICAgZS5vcHRpb25zLnJlZ2lvbiA9IGF3YWl0IHRoaXMuY2xpUHJvbXB0U2VsZWN0UmVnaW9uKFxuICAgICAgICAnV2hpY2ggcmVnaW9uIGFyZSB5b3UgdXBkYXRpbmc6ICcsXG4gICAgICAgIGZhbHNlLFxuICAgICAgICB0cnVlLFxuICAgICAgICBlLm9wdGlvbnMucmVnaW9uLFxuICAgICAgICBlLm9wdGlvbnMuc3RhZ2UsXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gdGhpcy5zdGFydFJlZ2lzdHJ5VXBkYXRlKGUpO1xuICAgIH1cblxuICAgIGFzeW5jIHBvc3RSZXNvdXJjZURlcGxveShlKSB7XG4gICAgICBpZiAoIVMuY29uZmlnLmludGVyYWN0aXZlIHx8IChlLm9wdGlvbnMuc3RhZ2UgJiYgZS5vcHRpb25zLnJlZ2lvbikpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2V0VmFyaWFibGVzRnJvbU91dHB1dChlKTtcbiAgICAgIH1cblxuICAgICAgZS5vcHRpb25zLnN0YWdlID0gYXdhaXQgdGhpcy5jbGlQcm9tcHRTZWxlY3RTdGFnZShcbiAgICAgICAgJ1doaWNoIHN0YWdlIGFyZSB5b3UgdXBkYXRpbmc6ICcsXG4gICAgICAgIGUub3B0aW9ucy5zdGFnZSxcbiAgICAgICAgZmFsc2UsXG4gICAgICApO1xuXG4gICAgICBlLm9wdGlvbnMucmVnaW9uID0gYXdhaXQgdGhpcy5jbGlQcm9tcHRTZWxlY3RSZWdpb24oXG4gICAgICAgICdXaGljaCByZWdpb24gYXJlIHlvdSB1cGRhdGluZzogJyxcbiAgICAgICAgZmFsc2UsXG4gICAgICAgIHRydWUsXG4gICAgICAgIGUub3B0aW9ucy5yZWdpb24sXG4gICAgICAgIGUub3B0aW9ucy5zdGFnZSxcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiB0aGlzLnNldFZhcmlhYmxlc0Zyb21PdXRwdXQoZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgc2V0VmFyaWFibGVzRnJvbU91dHB1dChlKSB7XG4gICAgICBTQ2xpLmxvZygnU2V0IHNlcnZlcmxlc3MgdmFyaWFibGVzIGZyb20gQ2xvdWRGb3JtYXRpb24gT3V0cHV0cy4uLi4nKTtcblxuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVuZGVyc2NvcmUtZGFuZ2xlXG4gICAgICBjb25zdCBzZXR0aW5ncyA9IFMuX3Byb2plY3QuZ2V0VmFyaWFibGVzT2JqZWN0KGUub3B0aW9ucy5zdGFnZSwgZS5vcHRpb25zLnJlZ2lvbik7XG5cbiAgICAgIGNvbnN0IGNmID0gUHJvbWlzZS5wcm9taXNpZnlBbGwobmV3IEFXUy5DbG91ZEZvcm1hdGlvbih7XG4gICAgICAgIHJlZ2lvbjogc2V0dGluZ3MucmVnaW9uLFxuICAgICAgfSkpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjZi5kZXNjcmliZVN0YWNrc0FzeW5jKHtcbiAgICAgICAgU3RhY2tOYW1lOiBzZXR0aW5ncy5yZXNvdXJjZXNTdGFja05hbWUgfHwgYCR7c2V0dGluZ3MucHJvamVjdH0tJHtzZXR0aW5ncy5zdGFnZX0tcmAsXG4gICAgICB9KTtcblxuICAgICAgaWYgKHJlc3VsdC5TdGFja3MubGVuZ3RoIDwgMSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgJ0NvdWxkIG5vdCBnZXQgQ2xvdWRGb3JtYXRpb24gc3RhY2sgaW5mb3JtYXRpb24gLSAnICtcbiAgICAgICAgICAndW5hYmxlIHRvIHNldCBzZXJ2ZXJsZXNzIHZhcmlhYmxlcycsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHN0YWNrID0gcmVzdWx0LlN0YWNrcy5wb3AoKTtcblxuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVuZGVyc2NvcmUtZGFuZ2xlXG4gICAgICBjb25zdCBzUHJvamVjdCA9IFMuX3Byb2plY3QuZ2V0UmVnaW9uKGUub3B0aW9ucy5zdGFnZSwgZS5vcHRpb25zLnJlZ2lvbik7XG5cbiAgICAgIGlmIChBcnJheS5pc0FycmF5KHN0YWNrLk91dHB1dHMpKSB7XG4gICAgICAgIHN0YWNrLk91dHB1dHMuZm9yRWFjaCgob3V0cHV0KSA9PiB7XG4gICAgICAgICAgY29uc3Qgb3V0cHV0VmFyID0ge307XG4gICAgICAgICAgY29uc3Qga2V5ID0gb3V0cHV0Lk91dHB1dEtleS5sb3dlcmNhc2VGaXJzdCgpO1xuICAgICAgICAgIG91dHB1dFZhcltrZXldID0gb3V0cHV0Lk91dHB1dFZhbHVlO1xuXG4gICAgICAgICAgc1Byb2plY3QuYWRkVmFyaWFibGVzKG91dHB1dFZhcik7XG4gICAgICAgICAgU0NsaS5sb2coYFNldCBzZXJ2ZXJsZXNzIHZhcmlhYmxlcyBcIiR7a2V5fVwiIHRvIFwiJHtvdXRwdXRWYXJba2V5XX1cImApO1xuICAgICAgICB9KTtcbiAgICAgICAgc1Byb2plY3Quc2F2ZSgpO1xuICAgICAgICBTQ2xpLmxvZygnU3VjY2Vzc2Z1bGx5IHNldCB2YXJpYWJsZShzKSBmcm9tIG91dHB1dHMuJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBTQ2xpLmxvZygnQ2xvdWRGb3JtYXRpb24gaGFzIG5vIE91dHB1dC4nKTtcbiAgICAgIH1cblxuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVuZGVyc2NvcmUtZGFuZ2xlXG4gICAgICBjb25zdCBldmVudHMgPSBTLl9wcm9qZWN0LmdldEFsbEV2ZW50cygpO1xuICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZXZlbnRzKSkge1xuICAgICAgICBjb25zdCBzdHJlYW1FdmVudHMgPSBldmVudHMuZmlsdGVyKGV2ZW50ID0+XG4gICAgICAgICAgKGV2ZW50LnR5cGUgPT09ICdkeW5hbW9kYnN0cmVhbScgfHwgZXZlbnQudHlwZSA9PT0gJ2tpbmVzaXNzdHJlYW0nKSk7XG5cbiAgICAgICAgaWYgKHN0cmVhbUV2ZW50cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICBTQ2xpLmxvZygnTm8gZXZlbnRzIHdpdGggdHlwZTogZHluYW1vZGJzdHJlYW0sIGtpbmVzaXNzdHJlYW0uJyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3QgYXdzTGFtYmRhID0gUHJvbWlzZS5wcm9taXNpZnlBbGwobmV3IEFXUy5MYW1iZGEoe1xuICAgICAgICAgICAgcmVnaW9uOiBzZXR0aW5ncy5yZWdpb24sXG4gICAgICAgICAgfSksIHsgc3VmZml4OiAnQXN5bmNlZCcgfSk7XG4gICAgICAgICAgY29uc3QgYXdzQWNjb3VudElkID0gUy5nZXRQcm92aWRlcigpLmdldEFjY291bnRJZChzZXR0aW5ncy5zdGFnZSwgc2V0dGluZ3MucmVnaW9uKTtcblxuICAgICAgICAgIGF3YWl0IFByb21pc2UuYWxsKHN0cmVhbUV2ZW50cy5tYXAoYXN5bmMgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICAvLyBHZXQgRXZlbnQgRGV0YWlsc1xuICAgICAgICAgICAgY29uc3QgcG9wdWxhdGVkID0gZXZlbnQudG9PYmplY3RQb3B1bGF0ZWQoc2V0dGluZ3MpO1xuICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG1heC1sZW5cbiAgICAgICAgICAgIGNvbnN0IGZ1bmN0aW9uQXJuID0gYGFybjphd3M6bGFtYmRhOiR7c2V0dGluZ3MucmVnaW9ufToke2F3c0FjY291bnRJZH06ZnVuY3Rpb246JHtzZXR0aW5ncy5wcm9qZWN0fS0ke2V2ZW50LmdldEZ1bmN0aW9uKCkubmFtZX06JHtzZXR0aW5ncy5zdGFnZX1gO1xuICAgICAgICAgICAgY29uc3QgZXZlbnRNYXBwaW5nID0gYXdhaXQgYXdzTGFtYmRhLmxpc3RFdmVudFNvdXJjZU1hcHBpbmdzQXN5bmNlZCh7XG4gICAgICAgICAgICAgIEZ1bmN0aW9uTmFtZTogZnVuY3Rpb25Bcm4sXG4gICAgICAgICAgICAgIEV2ZW50U291cmNlQXJuOiBwb3B1bGF0ZWQuY29uZmlnLnN0cmVhbUFybixcbiAgICAgICAgICAgICAgLy8gV2l0aCBhc3N1bXB0aW9uIHRoYXQgZWFjaCBmdW5jdGlvbiBvbmx5IHN1YnNjcmliZSB0byB0aGUgc2FtZSBzdHJlYW0gb25jZVxuICAgICAgICAgICAgICBNYXhJdGVtczogMSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgY29uc3QgZXZlbnRWYXIgPSB7fTtcblxuICAgICAgICAgICAgLy8gU2V0IHZhcmlhYmxlIHVzaW5nIGZpcnN0IHJlc3VsdCBpZiBleGlzdFxuICAgICAgICAgICAgaWYgKHR5cGVvZiBldmVudE1hcHBpbmcgIT09ICd1bmRlZmluZWQnICYmXG4gICAgICAgICAgICAgIEFycmF5LmlzQXJyYXkoZXZlbnRNYXBwaW5nLkV2ZW50U291cmNlTWFwcGluZ3MpICYmXG4gICAgICAgICAgICAgIGV2ZW50TWFwcGluZy5FdmVudFNvdXJjZU1hcHBpbmdzLmxlbmd0aCA+IDBcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICBjb25zdCBldmVudERldGFpbCA9IGV2ZW50TWFwcGluZy5FdmVudFNvdXJjZU1hcHBpbmdzWzBdO1xuICAgICAgICAgICAgICBjb25zdCBrZXkgPSBgZXZlbnRJRDoke3BvcHVsYXRlZC5uYW1lfWA7XG5cbiAgICAgICAgICAgICAgZXZlbnRWYXJba2V5XSA9IGV2ZW50RGV0YWlsLlVVSUQ7XG4gICAgICAgICAgICAgIHNQcm9qZWN0LmFkZFZhcmlhYmxlcyhldmVudFZhcik7XG4gICAgICAgICAgICAgIFNDbGkubG9nKGBTZXQgc2VydmVybGVzcyB2YXJpYWJsZXMgXCIke2tleX1cIiB0byBcIiR7ZXZlbnRWYXJba2V5XX1cImApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gZXZlbnRWYXI7XG4gICAgICAgICAgfSkpO1xuICAgICAgICAgIHNQcm9qZWN0LnNhdmUoKTtcbiAgICAgICAgICBTQ2xpLmxvZygnU3VjY2Vzc2Z1bGx5IHNldCB2YXJpYWJsZShzKSBmcm9tIHN0cmVhbSBldmVudHMuJyk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGU7XG4gICAgfVxuXG4gICAgZ2V0U2VydmljZURlZmluaXRpb25QYXRoKCkge1xuICAgICAgLy8gR2V0IHByb2plY3RQYXRoXG4gICAgICBjb25zdCBwcm9qZWN0UGF0aCA9IFMuY29uZmlnLnByb2plY3RQYXRoO1xuXG4gICAgICAvLyBDaGVjayBpZiB0cy1kZWZpbml0aW9uLmpzb24gZXhpc3RzIG9yIHdoZXRoZXIgdGhlcmUncyBhbiBhbHRlcm5hdGl2ZSBjb25maWdcbiAgICAgIGNvbnN0IGN1c3QgPSBTLmdldFByb2plY3QoKS5jdXN0b207XG4gICAgICBsZXQgY29uZmlnUGF0aDtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgZnMuYWNjZXNzU3luYyhgJHtwcm9qZWN0UGF0aH0vdHMtZGVmaW5pdGlvbi5qc29uYCwgZnMuUl9PSyk7XG4gICAgICAgIGNvbmZpZ1BhdGggPSBgJHtwcm9qZWN0UGF0aH0vdHMtZGVmaW5pdGlvbi5qc29uYDtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uZmlnUGF0aCA9IGZhbHNlO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWNvbmZpZ1BhdGggJiYgY3VzdCAmJiBjdXN0LnRlbWFuZG9SZWdpc3RyeSAmJiBjdXN0LnRlbWFuZG9SZWdpc3RyeS5zZXJ2aWNlRGVmaW5pdGlvbikge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGZzLmFjY2Vzc1N5bmMoYCR7cHJvamVjdFBhdGh9LyR7Y3VzdC50ZW1hbmRvUmVnaXN0cnkuc2VydmljZURlZmluaXRpb259YCwgZnMuUl9PSyk7XG4gICAgICAgICAgY29uZmlnUGF0aCA9IGAke3Byb2plY3RQYXRofS8ke2N1c3QudGVtYW5kb1JlZ2lzdHJ5LnNlcnZpY2VEZWZpbml0aW9ufWA7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICBjb25maWdQYXRoID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKCFjb25maWdQYXRoKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGNvbmZpZ1BhdGg7XG4gICAgfVxuXG4gICAgYXN5bmMgc3RhcnRSZWdpc3RyeVVwZGF0ZShlKSB7XG4gICAgICBTQ2xpLmxvZygnc3RhcnRSZWdpc3RyeVVwZGF0ZScpO1xuICAgICAgY29uc3QgZGVmaW5pdGlvblBhdGggPSB0aGlzLmdldFNlcnZpY2VEZWZpbml0aW9uUGF0aCgpO1xuICAgICAgLy8gY29uc29sZS5sb2coZGVmaW5pdGlvblBhdGgpO1xuXG4gICAgICBpZiAoIWRlZmluaXRpb25QYXRoKSB7XG4gICAgICAgIFNDbGkubG9nKCdTa2lwcGluZyBUZW1hbmRvIFNlcnZpY2UgUmVnaXN0cnkgdXBkYXRlIC0gbm8gc2VydmljZSBkZWZpbml0aW9uIGZvdW5kJyk7XG4gICAgICAgIHJldHVybiBlO1xuICAgICAgfVxuXG4gICAgICAvKiBlc2xpbnQtZGlzYWJsZSBuby11bmRlcnNjb3JlLWRhbmdsZSovXG4gICAgICBjb25zdCBzZXR0aW5ncyA9IFMuX3Byb2plY3QuZ2V0VmFyaWFibGVzT2JqZWN0KGUub3B0aW9ucy5zdGFnZSwgZS5vcHRpb25zLnJlZ2lvbik7XG4gICAgICAvKiBlc2xpbnQtZW5hYmxlIG5vLXVuZGVyc2NvcmUtZGFuZ2xlICovXG5cbiAgICAgIC8vIEdldCBBUEkgR2F0ZXdheSBkZXRhaWxzXG4gICAgICBjb25zdCBwcm92aWRlciA9IFMuZ2V0UHJvdmlkZXIoJ2F3cycpO1xuXG4gICAgICBjb25zdCBhcGlHYXRld2F5ID0gYXdhaXQgcHJvdmlkZXIuZ2V0QXBpQnlOYW1lKFxuICAgICAgICBzZXR0aW5ncy5wcm9qZWN0LFxuICAgICAgICBlLm9wdGlvbnMuc3RhZ2UsXG4gICAgICAgIGUub3B0aW9ucy5yZWdpb24sXG4gICAgICApO1xuXG4gICAgICAvLyBCdWlsZCBlbmRwb2ludCB1cmlcbiAgICAgIGNvbnN0IGVuZHBvaW50ID0gYGh0dHBzOi8vJHthcGlHYXRld2F5LmlkfS5leGVjdXRlLWFwaS4ke2Uub3B0aW9ucy5yZWdpb259LmFtYXpvbmF3cy5jb20vJHtlLm9wdGlvbnMuc3RhZ2V9YDtcblxuICAgICAgY29uc3QgY2YgPSBQcm9taXNlLnByb21pc2lmeUFsbChuZXcgQVdTLkNsb3VkRm9ybWF0aW9uKHtcbiAgICAgICAgcmVnaW9uOiBzZXR0aW5ncy5yZWdpb24sXG4gICAgICB9KSk7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjZi5kZXNjcmliZVN0YWNrc0FzeW5jKHtcbiAgICAgICAgU3RhY2tOYW1lOiBzZXR0aW5ncy5yZXNvdXJjZXNTdGFja05hbWUgfHwgYCR7c2V0dGluZ3MucHJvamVjdH0tJHtzZXR0aW5ncy5zdGFnZX0tcmAsXG4gICAgICB9KTtcblxuICAgICAgaWYgKHJlc3VsdC5TdGFja3MubGVuZ3RoIDwgMSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgJ0NvdWxkIG5vdCBnZXQgQ2xvdWRGb3JtYXRpb24gc3RhY2sgaW5mb3JtYXRpb24gLSAnICtcbiAgICAgICAgICAndW5hYmxlIHRvIHVwZGF0ZSBzZXJ2aWNlIHJlZ2lzdHJ5JyxcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgY29uc3Qgc3RhY2sgPSByZXN1bHQuU3RhY2tzLnBvcCgpO1xuXG4gICAgICBjb25zdCByID0gbmV3IFNlcnZpY2VSZWdpc3RyeShzZXR0aW5ncy5zdGFnZSwgJ3MzJyk7XG5cbiAgICAgIGNvbnN0IHNlcnZpY2VEZWZpbml0aW9uID0gSlNPTi5zdHJpbmdpZnkoci5zbSgpLmxvYWREZWZpbml0aW9uRmlsZShkZWZpbml0aW9uUGF0aCkpO1xuICAgICAgLy8gY29uc29sZS5sb2coc2VydmljZURlZmluaXRpb24pO1xuXG4gICAgICBjb25zdCBjZlZhcnMgPSB7fTtcblxuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXJlc3RyaWN0ZWQtc3ludGF4XG4gICAgICBmb3IgKGNvbnN0IG91dHB1dCBvZiBzdGFjay5PdXRwdXRzKSB7XG4gICAgICAgIGNmVmFyc1tvdXRwdXQuT3V0cHV0S2V5XSA9IG91dHB1dC5PdXRwdXRWYWx1ZTtcbiAgICAgIH1cblxuICAgICAgLy8gY29uc29sZS5sb2coY2ZWYXJzKTtcblxuICAgICAgY29uc3QgaW50ZXJwb2xhdG9yID0gbmV3IFRyYW5zSW50ZXJwb2xhdG9yKGNmVmFycywgeyBvcGVuOiAnJHsnLCBjbG9zZTogJ30nIH0pO1xuXG4gICAgICBjb25zdCB1cGRhdGVkRGVmaW5pdGlvbiA9IEpTT04ucGFyc2UoaW50ZXJwb2xhdG9yLmludGVycG9sYXRlKHNlcnZpY2VEZWZpbml0aW9uKSk7XG5cbiAgICAgIC8vIEJ1aWxkIERlcGxveW1lbnQgcGF5bG9hZFxuICAgICAgY29uc3QgZGVwbG95bWVudCA9IHtcbiAgICAgICAgcmVnaW9uOiBlLm9wdGlvbnMucmVnaW9uLFxuICAgICAgICBlbmRwb2ludCxcbiAgICAgICAgcXVldWVzOiB1cGRhdGVkRGVmaW5pdGlvbi5wdWJsaWNRdWV1ZXMsXG4gICAgICAgIGF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICB9O1xuXG4gICAgICBpZiAoZS5vcHRpb25zLnZlcnNpb24pIHtcbiAgICAgICAgZGVwbG95bWVudC52ZXJzaW9uID0gZS5vcHRpb25zLnZlcnNpb247XG4gICAgICB9XG5cbiAgICAgIFNDbGkubG9nKGBVcGRhdGluZyBUZW1hbmRvIFNlcnZpY2UgUmVnaXN0cnkgJHt1cGRhdGVkRGVmaW5pdGlvbi5pZH1gKTtcbiAgICAgIFNDbGkubG9nKGBEZXBsb3ltZW50IFBheWxvYWQ6ICR7SlNPTi5zdHJpbmdpZnkoZGVwbG95bWVudCl9YCk7XG4gICAgICBhd2FpdCByLmNhdGFsb2coKS5wdXREZXBsb3ltZW50KHVwZGF0ZWREZWZpbml0aW9uLmlkLCBkZXBsb3ltZW50KTtcbiAgICAgIFNDbGkubG9nKCdUZW1hbmRvIFNlcnZpY2UgUmVnaXN0cnkgdXBkYXRlZCBzdWNjZXNzZnVsbHkhJyk7XG5cbiAgICAgIHJldHVybiBlO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBQbHVnaW5UZW1hbmRvU2VydmljZVJlZ2lzdHJ5O1xufVxuIl19