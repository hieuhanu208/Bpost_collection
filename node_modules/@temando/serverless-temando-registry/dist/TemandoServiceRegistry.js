'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _getIterator2 = require('babel-runtime/core-js/get-iterator');

var _getIterator3 = _interopRequireDefault(_getIterator2);

var _toConsumableArray2 = require('babel-runtime/helpers/toConsumableArray');

var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _slicedToArray2 = require('babel-runtime/helpers/slicedToArray');

var _slicedToArray3 = _interopRequireDefault(_slicedToArray2);

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _bluebird = require('bluebird');

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _fsPromise = require('fs-promise');

var _fsPromise2 = _interopRequireDefault(_fsPromise);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _transInterpolator = require('trans-interpolator');

var _transInterpolator2 = _interopRequireDefault(_transInterpolator);

var _serviceRegistryLib = require('@temando/service-registry-lib');

var _lutils = require('lutils');

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _CfVariables = require('./CfVariables');

var _CfVariables2 = _interopRequireDefault(_CfVariables);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var TemandoServiceRegistry = function () {
  function TemandoServiceRegistry(serverless, options) {
    (0, _classCallCheck3.default)(this, TemandoServiceRegistry);

    _initialiseProps.call(this);

    this.serverless = serverless;
    this.options = options || {};

    this.hooks = {
      'registry:update:serverless': this.updateRegistry,
      'before:deploy:initialize': this.loadCfEnvironment,
      'after:deploy:deploy': this.setCfEnvironment,
      'before:offline:start': this.loadOfflineEnvironment,
      'before:offline:start:init': this.loadOfflineEnvironment
    };

    var _serverless = this.serverless,
        servicePath = _serverless.config.servicePath,
        yaml = _serverless.yamlParser,
        aws = _serverless.providers.aws,
        _serverless$service = _serverless.service,
        _serverless$service$c = _serverless$service.custom,
        custom = _serverless$service$c === undefined ? {} : _serverless$service$c,
        _serverless$service$p = _serverless$service.provider,
        region = _serverless$service$p.region,
        stage = _serverless$service$p.stage;

    /**
     * SET SERVICE DEFINITION CONFIG PATH
     */

    var customPath = custom.temandoRegistry && custom.temandoRegistry.serviceDefinition;

    var tryFiles = [_path2.default.join(servicePath, './ts-definition.json'), _path2.default.join(servicePath, './ts-definition.yml'), customPath && _path2.default.join(servicePath, customPath)].filter(function (v) {
      return v;
    });

    this.serviceDefinitionPath = tryFiles.find(function (filePath) {
      return _fsPromise2.default.existsSync(filePath);
    });

    /**
     * CfVariables
     */

    this.cfVariables = new _CfVariables2.default({
      // storagePath,
      yaml,
      aws,

      servicePath,
      region,
      stage,

      log: this.log
    });
  }

  /**
   * Called by `sls registry update`
   * Updates the registry with the endpoint payload and the serviceDefinition
   */


  /**
   * Loads in environment variables stored and mapped
   * into the in-memory `this.serverless.config` in order
   * for lambdas to deploy with augmented `environment` (process.env)
   */


  /**
   * Retrieves the
   */


  (0, _createClass3.default)(TemandoServiceRegistry, [{
    key: 'getStacks',


    /**
     * Retrieves CloudFormation stacks and handles errors
     *
     * @returns {Array} stacks
     */
    value: function () {
      var _ref = (0, _bluebird.coroutine)(_regenerator2.default.mark(function _callee() {
        var aws, _ref2, stacks;

        return _regenerator2.default.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                aws = this.serverless.providers.aws;
                _context.next = 3;
                return aws.request('CloudFormation', 'describeStacks', {
                  StackName: aws.naming.getStackName()
                });

              case 3:
                _ref2 = _context.sent;
                stacks = _ref2.Stacks;

                if (!(!stacks || stacks.length < 1)) {
                  _context.next = 7;
                  break;
                }

                throw new Error(`
        Could not get CloudFormation stack information -\
        unable to update service registry
      `);

              case 7:
                return _context.abrupt('return', stacks);

              case 8:
              case 'end':
                return _context.stop();
            }
          }
        }, _callee, this);
      }));

      function getStacks() {
        return _ref.apply(this, arguments);
      }

      return getStacks;
    }()
  }]);
  return TemandoServiceRegistry;
}();

var _initialiseProps = function _initialiseProps() {
  var _this = this;

  this.commands = {
    registry: {
      commands: {
        update: {
          lifecycleEvents: ['serverless'],
          usage: 'Update the Temando Registry',
          options: {
            stage: {
              usage: 'Optional if only one stage is defined in project',
              shortcut: 's'
            },
            region: {
              usage: 'Target one region to deploy to',
              shortcut: 'r'
            },
            version: {
              usage: 'The version being deployment',
              shortcut: 'v',
              required: false
            }
          }
        }
      }
    }
  };
  this.updateRegistry = (0, _bluebird.coroutine)(_regenerator2.default.mark(function _callee2() {
    var _serverless$service$p2, stage, region, stack, _ref4, _ref5, registry, serviceDefinition, cfVars, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, out, interpolator, updatedDefinition, queues, streams, topics, deployment;

    return _regenerator2.default.wrap(function _callee2$(_context2) {
      while (1) {
        switch (_context2.prev = _context2.next) {
          case 0:
            _serverless$service$p2 = _this.serverless.service.provider, stage = _serverless$service$p2.stage, region = _serverless$service$p2.region;
            stack = void 0;
            _context2.prev = 2;
            _context2.next = 5;
            return _this.getStacks();

          case 5:
            _ref4 = _context2.sent;
            _ref5 = (0, _slicedToArray3.default)(_ref4, 1);
            stack = _ref5[0];
            _context2.next = 15;
            break;

          case 10:
            _context2.prev = 10;
            _context2.t0 = _context2['catch'](2);

            _this.log('[REGISTRY] Skipping - invalid stack');
            _this.log('');
            return _context2.abrupt('return');

          case 15:
            registry = new _serviceRegistryLib.Registry(stage, 's3');
            serviceDefinition = (0, _stringify2.default)(registry.sm().loadDefinitionFile(_this.serviceDefinitionPath));
            cfVars = {};
            _iteratorNormalCompletion = true;
            _didIteratorError = false;
            _iteratorError = undefined;
            _context2.prev = 21;

            for (_iterator = (0, _getIterator3.default)(stack.Outputs); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
              out = _step.value;
              cfVars[out.OutputKey] = out.OutputValue;
            }

            _context2.next = 29;
            break;

          case 25:
            _context2.prev = 25;
            _context2.t1 = _context2['catch'](21);
            _didIteratorError = true;
            _iteratorError = _context2.t1;

          case 29:
            _context2.prev = 29;
            _context2.prev = 30;

            if (!_iteratorNormalCompletion && _iterator.return) {
              _iterator.return();
            }

          case 32:
            _context2.prev = 32;

            if (!_didIteratorError) {
              _context2.next = 35;
              break;
            }

            throw _iteratorError;

          case 35:
            return _context2.finish(32);

          case 36:
            return _context2.finish(29);

          case 37:
            interpolator = new _transInterpolator2.default(cfVars, { open: '${', close: '}' });
            updatedDefinition = JSON.parse(interpolator.interpolate(serviceDefinition));
            queues = [];
            streams = [];
            topics = [];


            if (updatedDefinition.resources) {
              updatedDefinition.resources.forEach(function (resource) {
                if (!cfVars[resource.output]) {
                  throw new Error(`Unable to map output variable "${resource.output}" for resource id "${resource.id}" of type "${resource.type}" to CloudFormation Outputs`);
                }

                if (resource.type === 'aws:sqs') {
                  queues.push({
                    id: resource.id,
                    description: resource.description,
                    url: cfVars[resource.output]
                  });
                } else if (resource.type === 'aws:sns') {
                  topics.push({
                    id: resource.id,
                    description: resource.description,
                    arn: cfVars[resource.output]
                  });
                } else if (resource.type === 'aws:kinesis') {
                  streams.push({
                    id: resource.id,
                    description: resource.description,
                    name: cfVars[resource.output]
                  });
                } else {
                  throw new Error(`Unsupported resource type "${resource.type}" for resource id "${resource.id}"`);
                }
              });
            }

            deployment = {
              region,
              endpoint: cfVars.ServiceEndpoint,
              queues: [].concat((0, _toConsumableArray3.default)(updatedDefinition.publicQueues), queues),
              streams,
              topics,
              at: new Date().toISOString()
            };


            if (_this.options.version) {
              deployment.version = _this.options.version;
            }

            _this.log(`[REGISTRY] Updating Temando Service Registry ${_chalk2.default.bold(updatedDefinition.id)}`);
            _this.log('[REGISTRY] Deployment Payload:');
            _this.log(`[REGISTRY] ${(0, _stringify2.default)(deployment, 2, 2)}`);
            _this.log('');

            _context2.next = 51;
            return registry.catalog().putDeployment(updatedDefinition.id, deployment);

          case 51:
            _this.log('[REGISTRY] Temando Service Registry updated successfully!');
            _this.log('');

          case 53:
          case 'end':
            return _context2.stop();
        }
      }
    }, _callee2, _this, [[2, 10], [21, 25, 29, 37], [30,, 32, 36]]);
  }));
  this.loadOfflineEnvironment = (0, _bluebird.coroutine)(_regenerator2.default.mark(function _callee3() {
    return _regenerator2.default.wrap(function _callee3$(_context3) {
      while (1) {
        switch (_context3.prev = _context3.next) {
          case 0:
            _this.log('[ENVIRONMENT] Loading cached CF Variables for Serverless Offline...');
            _this.log('');

            _context3.next = 4;
            return _this.cfVariables.initialize();

          case 4:
            _this.cfVariables.populateEnvironments(_this.serverless.service);

          case 5:
          case 'end':
            return _context3.stop();
        }
      }
    }, _callee3, _this);
  }));
  this.loadCfEnvironment = (0, _bluebird.coroutine)(_regenerator2.default.mark(function _callee4() {
    var stack, _ref8, _ref9, cfVars, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, out;

    return _regenerator2.default.wrap(function _callee4$(_context4) {
      while (1) {
        switch (_context4.prev = _context4.next) {
          case 0:
            _this.log('[ENVIRONMENT] Loading cached CF Variables...');
            _this.log('');

            _context4.next = 4;
            return _this.cfVariables.initialize();

          case 4:

            _this.log('[ENVIRONMENT] Retrieving variables from CloudFormation Outputs...');
            _this.log('');

            stack = void 0;
            _context4.prev = 7;
            _context4.next = 10;
            return _this.getStacks();

          case 10:
            _ref8 = _context4.sent;
            _ref9 = (0, _slicedToArray3.default)(_ref8, 1);
            stack = _ref9[0];
            _context4.next = 20;
            break;

          case 15:
            _context4.prev = 15;
            _context4.t0 = _context4['catch'](7);

            _this.log('[ENVIRONMENT] Skipping variable lookup - invalid stack');
            _this.log('');
            return _context4.abrupt('return');

          case 20:
            cfVars = {};

            if (!(stack && _lutils.typeOf.Array(stack.Outputs) && stack.Outputs.length)) {
              _context4.next = 48;
              break;
            }

            _iteratorNormalCompletion2 = true;
            _didIteratorError2 = false;
            _iteratorError2 = undefined;
            _context4.prev = 25;

            for (_iterator2 = (0, _getIterator3.default)(stack.Outputs); !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
              out = _step2.value;
              cfVars[out.OutputKey] = out.OutputValue;
            }
            _context4.next = 33;
            break;

          case 29:
            _context4.prev = 29;
            _context4.t1 = _context4['catch'](25);
            _didIteratorError2 = true;
            _iteratorError2 = _context4.t1;

          case 33:
            _context4.prev = 33;
            _context4.prev = 34;

            if (!_iteratorNormalCompletion2 && _iterator2.return) {
              _iterator2.return();
            }

          case 36:
            _context4.prev = 36;

            if (!_didIteratorError2) {
              _context4.next = 39;
              break;
            }

            throw _iteratorError2;

          case 39:
            return _context4.finish(36);

          case 40:
            return _context4.finish(33);

          case 41:
            _this.log('[ENVIRONMENT] Updating CF Variable store...');

            _this.cfVariables.updateStore(cfVars);
            _this.cfVariables.populateEnvironments(_this.serverless.service);

            _context4.next = 46;
            return _this.cfVariables.saveStore();

          case 46:
            _context4.next = 49;
            break;

          case 48:
            _this.log('[ENVIRONMENT] Note: CloudFormation has no Output');
            // TODO: stop here when logic below appropriates

          case 49:
          case 'end':
            return _context4.stop();
        }
      }
    }, _callee4, _this, [[7, 15], [25, 29, 33, 41], [34,, 36, 40]]);
  }));
  this.setCfEnvironment = (0, _bluebird.coroutine)(_regenerator2.default.mark(function _callee5() {
    var stack, _ref11, _ref12, cfVars, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, out;

    return _regenerator2.default.wrap(function _callee5$(_context5) {
      while (1) {
        switch (_context5.prev = _context5.next) {
          case 0:
            _context5.next = 2;
            return _this.cfVariables.initialize();

          case 2:

            _this.log('[ENVIRONMENT] Retrieving variables from CloudFormation Outputs...');
            _this.log('');

            stack = void 0;
            _context5.prev = 5;
            _context5.next = 8;
            return _this.getStacks();

          case 8:
            _ref11 = _context5.sent;
            _ref12 = (0, _slicedToArray3.default)(_ref11, 1);
            stack = _ref12[0];
            _context5.next = 18;
            break;

          case 13:
            _context5.prev = 13;
            _context5.t0 = _context5['catch'](5);

            _this.log('[ENVIRONMENT] Skipping variable lookup - invalid stack');
            _this.log('');
            return _context5.abrupt('return');

          case 18:
            cfVars = {};

            if (!(stack && _lutils.typeOf.Array(stack.Outputs) && stack.Outputs.length)) {
              _context5.next = 43;
              break;
            }

            _iteratorNormalCompletion3 = true;
            _didIteratorError3 = false;
            _iteratorError3 = undefined;
            _context5.prev = 23;

            for (_iterator3 = (0, _getIterator3.default)(stack.Outputs); !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
              out = _step3.value;
              cfVars[out.OutputKey] = out.OutputValue;
            }
            _context5.next = 31;
            break;

          case 27:
            _context5.prev = 27;
            _context5.t1 = _context5['catch'](23);
            _didIteratorError3 = true;
            _iteratorError3 = _context5.t1;

          case 31:
            _context5.prev = 31;
            _context5.prev = 32;

            if (!_iteratorNormalCompletion3 && _iterator3.return) {
              _iterator3.return();
            }

          case 34:
            _context5.prev = 34;

            if (!_didIteratorError3) {
              _context5.next = 37;
              break;
            }

            throw _iteratorError3;

          case 37:
            return _context5.finish(34);

          case 38:
            return _context5.finish(31);

          case 39:
            _this.log('[ENVIRONMENT] Updating CF Variable store...');
            _this.cfVariables.updateStore(cfVars);
            _context5.next = 44;
            break;

          case 43:
            _this.log('[ENVIRONMENT] Note: CloudFormation has no Output');
            // TODO: stop here when logic below appropriates

          case 44:

            _this.cfVariables.populateEnvironments(_this.serverless.service);

            _context5.next = 47;
            return _this.cfVariables.updateLambdaEnvironments(_this.serverless.service);

          case 47:
            _context5.next = 49;
            return _this.cfVariables.saveStore();

          case 49:

            _this.log('');

          case 50:
          case 'end':
            return _context5.stop();
        }
      }
    }, _callee5, _this, [[5, 13], [23, 27, 31, 39], [32,, 34, 38]]);
  }));

  this.log = function () {
    var _serverless$cli;

    return (_serverless$cli = _this.serverless.cli).log.apply(_serverless$cli, arguments);
  };
};

exports.default = TemandoServiceRegistry;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9UZW1hbmRvU2VydmljZVJlZ2lzdHJ5LmpzIl0sIm5hbWVzIjpbIlRlbWFuZG9TZXJ2aWNlUmVnaXN0cnkiLCJzZXJ2ZXJsZXNzIiwib3B0aW9ucyIsImhvb2tzIiwidXBkYXRlUmVnaXN0cnkiLCJsb2FkQ2ZFbnZpcm9ubWVudCIsInNldENmRW52aXJvbm1lbnQiLCJsb2FkT2ZmbGluZUVudmlyb25tZW50Iiwic2VydmljZVBhdGgiLCJjb25maWciLCJ5YW1sIiwieWFtbFBhcnNlciIsImF3cyIsInByb3ZpZGVycyIsInNlcnZpY2UiLCJjdXN0b20iLCJwcm92aWRlciIsInJlZ2lvbiIsInN0YWdlIiwiY3VzdG9tUGF0aCIsInRlbWFuZG9SZWdpc3RyeSIsInNlcnZpY2VEZWZpbml0aW9uIiwidHJ5RmlsZXMiLCJqb2luIiwiZmlsdGVyIiwidiIsInNlcnZpY2VEZWZpbml0aW9uUGF0aCIsImZpbmQiLCJleGlzdHNTeW5jIiwiZmlsZVBhdGgiLCJjZlZhcmlhYmxlcyIsImxvZyIsInJlcXVlc3QiLCJTdGFja05hbWUiLCJuYW1pbmciLCJnZXRTdGFja05hbWUiLCJzdGFja3MiLCJTdGFja3MiLCJsZW5ndGgiLCJFcnJvciIsImNvbW1hbmRzIiwicmVnaXN0cnkiLCJ1cGRhdGUiLCJsaWZlY3ljbGVFdmVudHMiLCJ1c2FnZSIsInNob3J0Y3V0IiwidmVyc2lvbiIsInJlcXVpcmVkIiwic3RhY2siLCJnZXRTdGFja3MiLCJzbSIsImxvYWREZWZpbml0aW9uRmlsZSIsImNmVmFycyIsIk91dHB1dHMiLCJvdXQiLCJPdXRwdXRLZXkiLCJPdXRwdXRWYWx1ZSIsImludGVycG9sYXRvciIsIm9wZW4iLCJjbG9zZSIsInVwZGF0ZWREZWZpbml0aW9uIiwiSlNPTiIsInBhcnNlIiwiaW50ZXJwb2xhdGUiLCJxdWV1ZXMiLCJzdHJlYW1zIiwidG9waWNzIiwicmVzb3VyY2VzIiwiZm9yRWFjaCIsInJlc291cmNlIiwib3V0cHV0IiwiaWQiLCJ0eXBlIiwicHVzaCIsImRlc2NyaXB0aW9uIiwidXJsIiwiYXJuIiwibmFtZSIsImRlcGxveW1lbnQiLCJlbmRwb2ludCIsIlNlcnZpY2VFbmRwb2ludCIsInB1YmxpY1F1ZXVlcyIsImF0IiwiRGF0ZSIsInRvSVNPU3RyaW5nIiwiYm9sZCIsImNhdGFsb2ciLCJwdXREZXBsb3ltZW50IiwiaW5pdGlhbGl6ZSIsInBvcHVsYXRlRW52aXJvbm1lbnRzIiwiQXJyYXkiLCJ1cGRhdGVTdG9yZSIsInNhdmVTdG9yZSIsInVwZGF0ZUxhbWJkYUVudmlyb25tZW50cyIsImNsaSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0lBRXFCQSxzQjtBQTZCbkIsa0NBQVlDLFVBQVosRUFBd0JDLE9BQXhCLEVBQWlDO0FBQUE7O0FBQUE7O0FBQy9CLFNBQUtELFVBQUwsR0FBa0JBLFVBQWxCO0FBQ0EsU0FBS0MsT0FBTCxHQUFlQSxXQUFXLEVBQTFCOztBQUVBLFNBQUtDLEtBQUwsR0FBYTtBQUNYLG9DQUE4QixLQUFLQyxjQUR4QjtBQUVYLGtDQUE0QixLQUFLQyxpQkFGdEI7QUFHWCw2QkFBdUIsS0FBS0MsZ0JBSGpCO0FBSVgsOEJBQXdCLEtBQUtDLHNCQUpsQjtBQUtYLG1DQUE2QixLQUFLQTtBQUx2QixLQUFiOztBQUorQixzQkFzQjNCLEtBQUtOLFVBdEJzQjtBQUFBLFFBYzNCTyxXQWQyQixlQWE3QkMsTUFiNkIsQ0FjM0JELFdBZDJCO0FBQUEsUUFnQmpCRSxJQWhCaUIsZUFnQjdCQyxVQWhCNkI7QUFBQSxRQWlCaEJDLEdBakJnQixlQWlCN0JDLFNBakI2QixDQWlCaEJELEdBakJnQjtBQUFBLDBDQWtCN0JFLE9BbEI2QjtBQUFBLG9EQW1CM0JDLE1BbkIyQjtBQUFBLFFBbUIzQkEsTUFuQjJCLHlDQW1CbEIsRUFuQmtCO0FBQUEsb0RBb0IzQkMsUUFwQjJCO0FBQUEsUUFvQmZD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c0NvbnRlbnQiOlsiaW1wb3J0IGZzcCBmcm9tICdmcy1wcm9taXNlJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IFRyYW5zSW50ZXJwb2xhdG9yIGZyb20gJ3RyYW5zLWludGVycG9sYXRvcic7XG5pbXBvcnQgeyBSZWdpc3RyeSBhcyBTZXJ2aWNlUmVnaXN0cnkgfSBmcm9tICdAdGVtYW5kby9zZXJ2aWNlLXJlZ2lzdHJ5LWxpYic7XG5pbXBvcnQgeyB0eXBlT2YgfSBmcm9tICdsdXRpbHMnO1xuaW1wb3J0IGMgZnJvbSAnY2hhbGsnO1xuaW1wb3J0IENmVmFyaWFibGVzIGZyb20gJy4vQ2ZWYXJpYWJsZXMnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBUZW1hbmRvU2VydmljZVJlZ2lzdHJ5IHtcbiAgY29tbWFuZHMgPSB7XG4gICAgcmVnaXN0cnk6IHtcbiAgICAgIGNvbW1hbmRzOiB7XG4gICAgICAgIHVwZGF0ZToge1xuICAgICAgICAgIGxpZmVjeWNsZUV2ZW50czogW1xuICAgICAgICAgICAgJ3NlcnZlcmxlc3MnLFxuICAgICAgICAgIF0sXG4gICAgICAgICAgdXNhZ2U6ICdVcGRhdGUgdGhlIFRlbWFuZG8gUmVnaXN0cnknLFxuICAgICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICAgIHN0YWdlOiB7XG4gICAgICAgICAgICAgIHVzYWdlOiAnT3B0aW9uYWwgaWYgb25seSBvbmUgc3RhZ2UgaXMgZGVmaW5lZCBpbiBwcm9qZWN0JyxcbiAgICAgICAgICAgICAgc2hvcnRjdXQ6ICdzJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICByZWdpb246IHtcbiAgICAgICAgICAgICAgdXNhZ2U6ICdUYXJnZXQgb25lIHJlZ2lvbiB0byBkZXBsb3kgdG8nLFxuICAgICAgICAgICAgICBzaG9ydGN1dDogJ3InLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHZlcnNpb246IHtcbiAgICAgICAgICAgICAgdXNhZ2U6ICdUaGUgdmVyc2lvbiBiZWluZyBkZXBsb3ltZW50JyxcbiAgICAgICAgICAgICAgc2hvcnRjdXQ6ICd2JyxcbiAgICAgICAgICAgICAgcmVxdWlyZWQ6IGZhbHNlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9LFxuICB9XG5cbiAgY29uc3RydWN0b3Ioc2VydmVybGVzcywgb3B0aW9ucykge1xuICAgIHRoaXMuc2VydmVybGVzcyA9IHNlcnZlcmxlc3M7XG4gICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcblxuICAgIHRoaXMuaG9va3MgPSB7XG4gICAgICAncmVnaXN0cnk6dXBkYXRlOnNlcnZlcmxlc3MnOiB0aGlzLnVwZGF0ZVJlZ2lzdHJ5LFxuICAgICAgJ2JlZm9yZTpkZXBsb3k6aW5pdGlhbGl6ZSc6IHRoaXMubG9hZENmRW52aXJvbm1lbnQsXG4gICAgICAnYWZ0ZXI6ZGVwbG95OmRlcGxveSc6IHRoaXMuc2V0Q2ZFbnZpcm9ubWVudCxcbiAgICAgICdiZWZvcmU6b2ZmbGluZTpzdGFydCc6IHRoaXMubG9hZE9mZmxpbmVFbnZpcm9ubWVudCxcbiAgICAgICdiZWZvcmU6b2ZmbGluZTpzdGFydDppbml0JzogdGhpcy5sb2FkT2ZmbGluZUVudmlyb25tZW50LFxuICAgIH07XG5cbiAgICBjb25zdCB7XG4gICAgICBjb25maWc6IHtcbiAgICAgICAgc2VydmljZVBhdGgsXG4gICAgICB9LFxuICAgICAgeWFtbFBhcnNlcjogeWFtbCxcbiAgICAgIHByb3ZpZGVyczogeyBhd3MgfSxcbiAgICAgIHNlcnZpY2U6IHtcbiAgICAgICAgY3VzdG9tID0ge30sXG4gICAgICAgIHByb3ZpZGVyOiB7IHJlZ2lvbiwgc3RhZ2UgfSxcbiAgICAgIH0sXG4gICAgfSA9IHRoaXMuc2VydmVybGVzcztcblxuICAgIC8qKlxuICAgICAqIFNFVCBTRVJWSUNFIERFRklOSVRJT04gQ09ORklHIFBBVEhcbiAgICAgKi9cblxuICAgIGNvbnN0IGN1c3RvbVBhdGggPSBjdXN0b20udGVtYW5kb1JlZ2lzdHJ5ICYmIGN1c3RvbS50ZW1hbmRvUmVnaXN0cnkuc2VydmljZURlZmluaXRpb247XG5cbiAgICBjb25zdCB0cnlGaWxlcyA9IFtcbiAgICAgIHBhdGguam9pbihzZXJ2aWNlUGF0aCwgJy4vdHMtZGVmaW5pdGlvbi5qc29uJyksXG4gICAgICBwYXRoLmpvaW4oc2VydmljZVBhdGgsICcuL3RzLWRlZmluaXRpb24ueW1sJyksXG4gICAgICAoY3VzdG9tUGF0aCAmJiBwYXRoLmpvaW4oc2VydmljZVBhdGgsIGN1c3RvbVBhdGgpKSxcbiAgICBdLmZpbHRlcih2ID0+IHYpO1xuXG4gICAgdGhpcy5zZXJ2aWNlRGVmaW5pdGlvblBhdGggPSB0cnlGaWxlcy5maW5kKFxuICAgICAgZmlsZVBhdGggPT4gZnNwLmV4aXN0c1N5bmMoZmlsZVBhdGgpLFxuICAgICk7XG5cbiAgICAvKipcbiAgICAgKiBDZlZhcmlhYmxlc1xuICAgICAqL1xuXG4gICAgdGhpcy5jZlZhcmlhYmxlcyA9IG5ldyBDZlZhcmlhYmxlcyh7XG4gICAgICAvLyBzdG9yYWdlUGF0aCxcbiAgICAgIHlhbWwsXG4gICAgICBhd3MsXG5cbiAgICAgIHNlcnZpY2VQYXRoLFxuICAgICAgcmVnaW9uLFxuICAgICAgc3RhZ2UsXG5cbiAgICAgIGxvZzogdGhpcy5sb2csXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQ2FsbGVkIGJ5IGBzbHMgcmVnaXN0cnkgdXBkYXRlYFxuICAgKiBVcGRhdGVzIHRoZSByZWdpc3RyeSB3aXRoIHRoZSBlbmRwb2ludCBwYXlsb2FkIGFuZCB0aGUgc2VydmljZURlZmluaXRpb25cbiAgICovXG4gIHVwZGF0ZVJlZ2lzdHJ5ID0gYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHsgcHJvdmlkZXI6IHsgc3RhZ2UsIHJlZ2lvbiB9IH0gPSB0aGlzLnNlcnZlcmxlc3Muc2VydmljZTtcblxuICAgIGxldCBzdGFjaztcbiAgICB0cnkge1xuICAgICAgW3N0YWNrXSA9IGF3YWl0IHRoaXMuZ2V0U3RhY2tzKCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aGlzLmxvZygnW1JFR0lTVFJZXSBTa2lwcGluZyAtIGludmFsaWQgc3RhY2snKTtcbiAgICAgIHRoaXMubG9nKCcnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCByZWdpc3RyeSA9IG5ldyBTZXJ2aWNlUmVnaXN0cnkoc3RhZ2UsICdzMycpO1xuXG4gICAgY29uc3Qgc2VydmljZURlZmluaXRpb24gPSBKU09OLnN0cmluZ2lmeShcbiAgICAgIHJlZ2lzdHJ5LnNtKCkubG9hZERlZmluaXRpb25GaWxlKHRoaXMuc2VydmljZURlZmluaXRpb25QYXRoKSxcbiAgICApO1xuXG4gICAgY29uc3QgY2ZWYXJzID0ge307XG4gICAgZm9yIChjb25zdCBvdXQgb2Ygc3RhY2suT3V0cHV0cykgeyBjZlZhcnNbb3V0Lk91dHB1dEtleV0gPSBvdXQuT3V0cHV0VmFsdWU7IH1cblxuICAgIGNvbnN0IGludGVycG9sYXRvciA9IG5ldyBUcmFuc0ludGVycG9sYXRvcihjZlZhcnMsIHsgb3BlbjogJyR7JywgY2xvc2U6ICd9JyB9KTtcblxuICAgIGNvbnN0IHVwZGF0ZWREZWZpbml0aW9uID0gSlNPTi5wYXJzZShpbnRlcnBvbGF0b3IuaW50ZXJwb2xhdGUoc2VydmljZURlZmluaXRpb24pKTtcblxuICAgIGNvbnN0IHF1ZXVlcyA9IFtdO1xuICAgIGNvbnN0IHN0cmVhbXMgPSBbXTtcbiAgICBjb25zdCB0b3BpY3MgPSBbXTtcblxuICAgIGlmICh1cGRhdGVkRGVmaW5pdGlvbi5yZXNvdXJjZXMpIHtcbiAgICAgIHVwZGF0ZWREZWZpbml0aW9uLnJlc291cmNlcy5mb3JFYWNoKChyZXNvdXJjZSkgPT4ge1xuICAgICAgICBpZiAoIWNmVmFyc1tyZXNvdXJjZS5vdXRwdXRdKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gbWFwIG91dHB1dCB2YXJpYWJsZSBcIiR7cmVzb3VyY2Uub3V0cHV0fVwiIGZvciByZXNvdXJjZSBpZCBcIiR7cmVzb3VyY2UuaWR9XCIgb2YgdHlwZSBcIiR7cmVzb3VyY2UudHlwZX1cIiB0byBDbG91ZEZvcm1hdGlvbiBPdXRwdXRzYCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocmVzb3VyY2UudHlwZSA9PT0gJ2F3czpzcXMnKSB7XG4gICAgICAgICAgcXVldWVzLnB1c2goe1xuICAgICAgICAgICAgaWQ6IHJlc291cmNlLmlkLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IHJlc291cmNlLmRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgdXJsOiBjZlZhcnNbcmVzb3VyY2Uub3V0cHV0XSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIGlmIChyZXNvdXJjZS50eXBlID09PSAnYXdzOnNucycpIHtcbiAgICAgICAgICB0b3BpY3MucHVzaCh7XG4gICAgICAgICAgICBpZDogcmVzb3VyY2UuaWQsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogcmVzb3VyY2UuZGVzY3JpcHRpb24sXG4gICAgICAgICAgICBhcm46IGNmVmFyc1tyZXNvdXJjZS5vdXRwdXRdLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2UgaWYgKHJlc291cmNlLnR5cGUgPT09ICdhd3M6a2luZXNpcycpIHtcbiAgICAgICAgICBzdHJlYW1zLnB1c2goe1xuICAgICAgICAgICAgaWQ6IHJlc291cmNlLmlkLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IHJlc291cmNlLmRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgbmFtZTogY2ZWYXJzW3Jlc291cmNlLm91dHB1dF0sXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbnN1cHBvcnRlZCByZXNvdXJjZSB0eXBlIFwiJHtyZXNvdXJjZS50eXBlfVwiIGZvciByZXNvdXJjZSBpZCBcIiR7cmVzb3VyY2UuaWR9XCJgKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgZGVwbG95bWVudCA9IHtcbiAgICAgIHJlZ2lvbixcbiAgICAgIGVuZHBvaW50OiBjZlZhcnMuU2VydmljZUVuZHBvaW50LFxuICAgICAgcXVldWVzOiBbLi4udXBkYXRlZERlZmluaXRpb24ucHVibGljUXVldWVzLCAuLi5xdWV1ZXNdLFxuICAgICAgc3RyZWFtcyxcbiAgICAgIHRvcGljcyxcbiAgICAgIGF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgfTtcblxuICAgIGlmICh0aGlzLm9wdGlvbnMudmVyc2lvbikge1xuICAgICAgZGVwbG95bWVudC52ZXJzaW9uID0gdGhpcy5vcHRpb25zLnZlcnNpb247XG4gICAgfVxuXG4gICAgdGhpcy5sb2coYFtSRUdJU1RSWV0gVXBkYXRpbmcgVGVtYW5kbyBTZXJ2aWNlIFJlZ2lzdHJ5ICR7Yy5ib2xkKHVwZGF0ZWREZWZpbml0aW9uLmlkKX1gKTtcbiAgICB0aGlzLmxvZygnW1JFR0lTVFJZXSBEZXBsb3ltZW50IFBheWxvYWQ6Jyk7XG4gICAgdGhpcy5sb2coYFtSRUdJU1RSWV0gJHtKU09OLnN0cmluZ2lmeShkZXBsb3ltZW50LCAyLCAyKX1gKTtcbiAgICB0aGlzLmxvZygnJyk7XG5cbiAgICBhd2FpdCByZWdpc3RyeS5jYXRhbG9nKCkucHV0RGVwbG95bWVudCh1cGRhdGVkRGVmaW5pdGlvbi5pZCwgZGVwbG95bWVudCk7XG4gICAgdGhpcy5sb2coJ1tSRUdJU1RSWV0gVGVtYW5kbyBTZXJ2aWNlIFJlZ2lzdHJ5IHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5IScpO1xuICAgIHRoaXMubG9nKCcnKTtcbiAgfVxuXG5cbiAgbG9hZE9mZmxpbmVFbnZpcm9ubWVudCA9IGFzeW5jICgpID0+IHtcbiAgICB0aGlzLmxvZygnW0VOVklST05NRU5UXSBMb2FkaW5nIGNhY2hlZCBDRiBWYXJpYWJsZXMgZm9yIFNlcnZlcmxlc3MgT2ZmbGluZS4uLicpO1xuICAgIHRoaXMubG9nKCcnKTtcblxuICAgIGF3YWl0IHRoaXMuY2ZWYXJpYWJsZXMuaW5pdGlhbGl6ZSgpO1xuICAgIHRoaXMuY2ZWYXJpYWJsZXMucG9wdWxhdGVFbnZpcm9ubWVudHModGhpcy5zZXJ2ZXJsZXNzLnNlcnZpY2UpO1xuICB9XG5cbiAgLyoqXG4gICAqIExvYWRzIGluIGVudmlyb25tZW50IHZhcmlhYmxlcyBzdG9yZWQgYW5kIG1hcHBlZFxuICAgKiBpbnRvIHRoZSBpbi1tZW1vcnkgYHRoaXMuc2VydmVybGVzcy5jb25maWdgIGluIG9yZGVyXG4gICAqIGZvciBsYW1iZGFzIHRvIGRlcGxveSB3aXRoIGF1Z21lbnRlZCBgZW52aXJvbm1lbnRgIChwcm9jZXNzLmVudilcbiAgICovXG4gIGxvYWRDZkVudmlyb25tZW50ID0gYXN5bmMgKCkgPT4ge1xuICAgIHRoaXMubG9nKCdbRU5WSVJPTk1FTlRdIExvYWRpbmcgY2FjaGVkIENGIFZhcmlhYmxlcy4uLicpO1xuICAgIHRoaXMubG9nKCcnKTtcblxuICAgIGF3YWl0IHRoaXMuY2ZWYXJpYWJsZXMuaW5pdGlhbGl6ZSgpO1xuXG4gICAgdGhpcy5sb2coJ1tFTlZJUk9OTUVOVF0gUmV0cmlldmluZyB2YXJpYWJsZXMgZnJvbSBDbG91ZEZvcm1hdGlvbiBPdXRwdXRzLi4uJyk7XG4gICAgdGhpcy5sb2coJycpO1xuXG4gICAgbGV0IHN0YWNrO1xuICAgIHRyeSB7XG4gICAgICBbc3RhY2tdID0gYXdhaXQgdGhpcy5nZXRTdGFja3MoKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRoaXMubG9nKCdbRU5WSVJPTk1FTlRdIFNraXBwaW5nIHZhcmlhYmxlIGxvb2t1cCAtIGludmFsaWQgc3RhY2snKTtcbiAgICAgIHRoaXMubG9nKCcnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBjZlZhcnMgPSB7fTtcblxuICAgIGlmIChzdGFjayAmJiB0eXBlT2YuQXJyYXkoc3RhY2suT3V0cHV0cykgJiYgc3RhY2suT3V0cHV0cy5sZW5ndGgpIHtcbiAgICAgIGZvciAoY29uc3Qgb3V0IG9mIHN0YWNrLk91dHB1dHMpIHsgY2ZWYXJzW291dC5PdXRwdXRLZXldID0gb3V0Lk91dHB1dFZhbHVlOyB9XG4gICAgICB0aGlzLmxvZygnW0VOVklST05NRU5UXSBVcGRhdGluZyBDRiBWYXJpYWJsZSBzdG9yZS4uLicpO1xuXG4gICAgICB0aGlzLmNmVmFyaWFibGVzLnVwZGF0ZVN0b3JlKGNmVmFycyk7XG4gICAgICB0aGlzLmNmVmFyaWFibGVzLnBvcHVsYXRlRW52aXJvbm1lbnRzKHRoaXMuc2VydmVybGVzcy5zZXJ2aWNlKTtcblxuICAgICAgYXdhaXQgdGhpcy5jZlZhcmlhYmxlcy5zYXZlU3RvcmUoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5sb2coJ1tFTlZJUk9OTUVOVF0gTm90ZTogQ2xvdWRGb3JtYXRpb24gaGFzIG5vIE91dHB1dCcpO1xuICAgICAgLy8gVE9ETzogc3RvcCBoZXJlIHdoZW4gbG9naWMgYmVsb3cgYXBwcm9wcmlhdGVzXG4gICAgfVxuICB9XG5cblxuICAvKipcbiAgICogUmV0cmlldmVzIHRoZVxuICAgKi9cbiAgc2V0Q2ZFbnZpcm9ubWVudCA9IGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCB0aGlzLmNmVmFyaWFibGVzLmluaXRpYWxpemUoKTtcblxuICAgIHRoaXMubG9nKCdbRU5WSVJPTk1FTlRdIFJldHJpZXZpbmcgdmFyaWFibGVzIGZyb20gQ2xvdWRGb3JtYXRpb24gT3V0cHV0cy4uLicpO1xuICAgIHRoaXMubG9nKCcnKTtcblxuICAgIGxldCBzdGFjaztcbiAgICB0cnkge1xuICAgICAgW3N0YWNrXSA9IGF3YWl0IHRoaXMuZ2V0U3RhY2tzKCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aGlzLmxvZygnW0VOVklST05NRU5UXSBTa2lwcGluZyB2YXJpYWJsZSBsb29rdXAgLSBpbnZhbGlkIHN0YWNrJyk7XG4gICAgICB0aGlzLmxvZygnJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgY2ZWYXJzID0ge307XG5cbiAgICBpZiAoc3RhY2sgJiYgdHlwZU9mLkFycmF5KHN0YWNrLk91dHB1dHMpICYmIHN0YWNrLk91dHB1dHMubGVuZ3RoKSB7XG4gICAgICBmb3IgKGNvbnN0IG91dCBvZiBzdGFjay5PdXRwdXRzKSB7IGNmVmFyc1tvdXQuT3V0cHV0S2V5XSA9IG91dC5PdXRwdXRWYWx1ZTsgfVxuICAgICAgdGhpcy5sb2coJ1tFTlZJUk9OTUVOVF0gVXBkYXRpbmcgQ0YgVmFyaWFibGUgc3RvcmUuLi4nKTtcbiAgICAgIHRoaXMuY2ZWYXJpYWJsZXMudXBkYXRlU3RvcmUoY2ZWYXJzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5sb2coJ1tFTlZJUk9OTUVOVF0gTm90ZTogQ2xvdWRGb3JtYXRpb24gaGFzIG5vIE91dHB1dCcpO1xuICAgICAgLy8gVE9ETzogc3RvcCBoZXJlIHdoZW4gbG9naWMgYmVsb3cgYXBwcm9wcmlhdGVzXG4gICAgfVxuXG4gICAgdGhpcy5jZlZhcmlhYmxlcy5wb3B1bGF0ZUVudmlyb25tZW50cyh0aGlzLnNlcnZlcmxlc3Muc2VydmljZSk7XG5cbiAgICBhd2FpdCB0aGlzLmNmVmFyaWFibGVzLnVwZGF0ZUxhbWJkYUVudmlyb25tZW50cyh0aGlzLnNlcnZlcmxlc3Muc2VydmljZSk7XG5cbiAgICBhd2FpdCB0aGlzLmNmVmFyaWFibGVzLnNhdmVTdG9yZSgpO1xuXG4gICAgdGhpcy5sb2coJycpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHJpZXZlcyBDbG91ZEZvcm1hdGlvbiBzdGFja3MgYW5kIGhhbmRsZXMgZXJyb3JzXG4gICAqXG4gICAqIEByZXR1cm5zIHtBcnJheX0gc3RhY2tzXG4gICAqL1xuICBhc3luYyBnZXRTdGFja3MoKSB7XG4gICAgY29uc3QgeyBhd3MgfSA9IHRoaXMuc2VydmVybGVzcy5wcm92aWRlcnM7XG5cbiAgICBjb25zdCB7IFN0YWNrczogc3RhY2tzIH0gPSBhd2FpdCBhd3MucmVxdWVzdCgnQ2xvdWRGb3JtYXRpb24nLCAnZGVzY3JpYmVTdGFja3MnLCB7XG4gICAgICBTdGFja05hbWU6IGF3cy5uYW1pbmcuZ2V0U3RhY2tOYW1lKCksXG4gICAgfSk7XG5cbiAgICBpZiAoIXN0YWNrcyB8fCBzdGFja3MubGVuZ3RoIDwgMSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBcbiAgICAgICAgQ291bGQgbm90IGdldCBDbG91ZEZvcm1hdGlvbiBzdGFjayBpbmZvcm1hdGlvbiAtXFxcbiAgICAgICAgdW5hYmxlIHRvIHVwZGF0ZSBzZXJ2aWNlIHJlZ2lzdHJ5XG4gICAgICBgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc3RhY2tzO1xuICB9XG5cbiAgbG9nID0gKC4uLmFyZ3MpID0+IHRoaXMuc2VydmVybGVzcy5jbGkubG9nKC4uLmFyZ3MpXG59XG4iXX0=