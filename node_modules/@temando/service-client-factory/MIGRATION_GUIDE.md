# Migration Guide

The migration guide is aimed at Temando developers who are looking to move from
an older major version of Service Client Factory to a newer version. It should
be used in conjunction with the [`CHANGELOG`](CHANGELOG.md).

## Migration from v1.x to v2.x

Service Client Factory v2 requires minimal developer effort to migrate.

### Instantiate Service Client Factory

The method signature remains unchanged, but `definitions` and `environment`
configuration options have been renamed:

```js
// v1.x constructor, returns `ServiceClient`
const scf = new ServiceClientFactory({
  definitions: tsDefinition,
  environment: tsEnv,
  callId: event.callId,
  /** Required: Call depth incremented by 1 from x-temando-service-call-depth header (set to 0 if no previous request) */
  callDepth: 1
});

// v2.x constructor, still returns `ServiceClient`
const scf = new ServiceClientFactory({
  tsDefinition: tsDefinition,
  tsEnv: tsEnv,
  ...
});
```

### `ServiceClientFactory` changes

`ServiceClientFactory` now also extends Node's [`EventEmitter`](https://nodejs.org/dist/latest-v6.x/docs/api/events.html#events_class_eventemitter)
class and raises the following events:

- `create`

## Migrating from v0.7.2 to v1.x

This was a complete rewrite of Service Client Factory, and most interfaces were
modified or altered in some way.

### Instantiate Service Client Factory

The constructor has changed from accepting three arguments, to accepting a
configuration object with a new required option, `callDepth`:

```js
// v0.7.2 constructor, returns a `ServiceClient`
const scf = new ServiceClientFactory(event.callId, tsDefinition, tsEnv);

// v1.x constructor, still returns `ServiceClient`
const scf = new ServiceClientFactory({
  definitions: tsDefinition,
  environment: tsEnv,
  callId: event.callId,
  /** Required: Call depth incremented by 1 from x-temando-service-call-depth header (set to 0 if no previous request) */
  callDepth: 1
});
```

See [README.md](https://src.temando.io/service-registry/service-client-factory/tree/v1.0.0#instantiate-service-client-factory) for more details.

### `ServiceClientFactory` changes

Assuming you have a `scf` instance (from above):

|                    Old                     |                New                |                                                                                                                                     Notes                                                                                                                                     |
| ------------------------------------------ | --------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `createServiceClient(serviceName, region)` | `create({ name: serviceName })`   | Takes an object of type [`IClientConfig`](https://src.temando.io/service-registry/service-client-factory/blob/v1.0.0/src/types.ts#L47). See [README](https://src.temando.io/service-registry/service-client-factory/tree/v1.0.0#create-service-client) for an example config. |
| `getServiceUrl()`                          | -                                 | Method removed, there is no replacement.                                                                                                                                                                                                                                      |
| `getServiceConfig()`                       | -                                 | Method removed, there is no replacement.                                                                                                                                                                                                                                      |
| `setRequestReference()`                    | `scf.callId = 'your-new-callId';` | Method replaced with a direct setter.                                                                                                                                                                                                                                         |
| `getRequestReference()`                    | `scf.callId`                      | Method replaced with a direct getter.                                                                                                                                                                                                                                         |
| `getRegisteredServices()`                  | -                                 | Method removed, there is no replacement.                                                                                                                                                                                                                                      |

### `ServiceClient` changes

Note that v1.0.0 removes `axios` as the underlying transport in favour of the
WhatWG Fetch standard (via `isomorphic-fetch`). This impacts the request and
response object returned from most of the HTTP methods. Assuming you have
created a `ServiceClient` using `scf.create()`, the following changes are
relevant:

|           Old            |           New           |                                                                                                                                              Notes                                                                                                                                              |
| ------------------------ | ----------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `setName`                | -                       | Automatically set when initialised via `scf.create()`, using the `name` argument.                                                                                                                                                                                                               |
| `getName`                | `.name`                 | Method replaced by a readonly getter.                                                                                                                                                                                                                                                           |
| `request(config)`        | `request(path, config)` | `config` is now fetch [`options`](https://github.github.io/fetch/#options).                                                                                                                                                                                                                     |
| `get`                    | -                       | Use `request(path, { method: 'GET' })`.                                                                                                                                                                                                                                                         |
| `delete`                 | -                       | Use `request(path, { method: 'DELETE' })`.                                                                                                                                                                                                                                                      |
| `post`                   | -                       | Use `request(path, { method: 'POST', body: '<data>' })`, with a valid [body type](https://github.github.io/fetch/#request-body).                                                                                                                                                                |
| `put`                    | -                       | Use `request(path, { method: 'PUT', body: '<data>' })`, with a valid [body type](https://github.github.io/fetch/#request-body).                                                                                                                                                                 |
| `patch`                  | -                       | Use `request(path, { method: 'PATCH', body: '<data>' })`, with a valid [body type](https://github.github.io/fetch/#request-body).                                                                                                                                                               |
| `all`                    | -                       | Use `Promise.all([request(...), request(...)])`.                                                                                                                                                                                                                                                |
| `spread`                 | -                       | Use native ES6 spread operator (...).                                                                                                                                                                                                                                                           |
| `enqueue(queue, params)` | `enqueue(name, config)` | Note that `config` is now of type [`IEnqueueConfig`](https://src.temando.io/service-registry/service-client-factory/blob/v1.0.0/src/types.ts#L175). Also see [Send a message to a queue](https://src.temando.io/service-registry/service-client-factory/tree/v1.0.0#send-a-message-to-a-queue). |

Two new methods have been added to `ServiceClient` which allow services to
push messages to AWS SNS and Kinesis Streams:

- [Send message to a SNS topic](https://src.temando.io/service-registry/service-client-factory/tree/v1.0.0#send-a-message-to-an-sns-topic)
- [Send record to a stream](https://src.temando.io/service-registry/service-client-factory/tree/v1.0.0#stream-a-record-to-a-stream)

Finally, `ServiceClient` now extends Node's [`EventEmitter`](https://nodejs.org/dist/latest-v6.x/docs/api/events.html#events_class_eventemitter)
class and raises the following events:

- `request.start`
- `request.end`
- `enqueue.start`
- `enqueue.end`
- `message.start`
- `message.end`
- `stream.start`
- `stream.end`

#### Request changes

All requests **must** include the following headers:

- `Code`
- `Account-Id`
- `X-Temando-Service-Call-Depth`
- `Sovereignty`

For the most part, these headers should be passed to your service from upstream
requests. You can set them on each request yourself, or alternatively these
values can be provided when using `scf.create()` to have the headers
automatically set when you using any of `ServiceClient`'s methods.

These headers ensure data is written (and read) from the correct place, as
well as helping troubleshooting and monitoring.

See [Make a HTTP request](https://src.temando.io/service-registry/service-client-factory/tree/v1.0.0#make-a-http-request).
