# Service Client Factory

[![build status](https://src.temando.io/service-registry/service-client-factory/badges/master/build.svg)](https://src.temando.io/service-registry/service-client-factory/commits/master) [![coverage report](https://src.temando.io/service-registry/service-client-factory/badges/master/coverage.svg)](https://src.temando.io/service-registry/service-client-factory/commits/master)

Temando platform services don't typically provide functionality in isolation. Services often make use of other services to fulfil their purpose.

The Service Client Factory:

- Is a library used by services that need to communicate with other services within a platform environment.
- Provides service client creation so that developers don't have to create their own clients to communicate with other services or write environment-specific code.

Service clients created by Service Client Factory are:

- An HTTP client that uses the [WHATWG Fetch standard](https://fetch.spec.whatwg.org/).
- A queue client that uses [AWS Simple Queue Service (SQS)](https://aws.amazon.com/sqs/).
- A notification/messaging client that uses [AWS Simple Notification Service (SNS)](https://aws.amazon.com/sns/).
- A data streaming client that uses [AWS Kinesis](https://aws.amazon.com/kinesis/)

See [API Reference](docs/index.html "gitlab-artifact|851|docs") for the complete list of functions.

For more information about Service Registry, refer to:

- [Service Registry project](https://src.temando.io/service-registry/service-registry).
- [Platform Services](http://docs.temando.io/platform-services-tome/) tome.

## Table of Contents

- [Service Client Factory](#service-client-factory)
  - [Table of Contents](#table-of-contents)
  - [Installation](#installation)
  - [Usage](#usage)
    - [Instantiate Service Client Factory](#instantiate-service-client-factory)
    - [Create service client](#create-service-client)
    - [Add a service on the fly](#register-service)
    - [Make a HTTP Request](#make-a-http-request)
    - [Send a message to a queue](#send-a-message-to-a-queue)
    - [Send a message to an SNS Topic](#send-a-message-to-an-sns-topic)
    - [Stream a record to a stream](#stream-a-record-to-a-stream)
  - [Utilities](#utilities)
    - [getServiceDefinition](#getservicedefinition)
    - [getServiceEnv](#getserviceenv)

## Installation

To add Service Client Factory as a dependency to your service, run the following command:

```sh
yarn add --save @temando/service-client-factory
```

`yarn` adds the new dependency to the project's `package.json` file.

## Usage

The following code snippet shows example service client creation and usage:

### Instantiate Service Client Factory

```javascript
import { ServiceClientFactory } from '@temando/service-client-factory';
import { getServiceDefinition, getServiceEnv } from '@temando/service-client-factory/utils';

const scf = new ServiceClientFactory({
  /** Optional: Call ID derived from x-temando-service-call header (will generate one if one doesn't already exist)*/
  callId: 'b4cffe49-1227-4862-acaf-94c30b05ea01',
  /** Required: Call depth incremented by 1 from x-temando-service-call-depth header (set to 0 if no previous request) */
  callDepth: 1,
  /** Required: Contents of `ts-definition.json` */
  tsDefinition: getServiceDefinition('./ts-definition.json'),
  /** Required: Contents of `ts-env.json` */
  tsEnv: getServiceEnv('./ts-env.json'),
});
```

### Create service client

```javascript
// Where `temando-sample-service` is the Service ID that you want to communicate with.
const sampleClient = scf.create({
  /** Required: Service name */
  name: 'temando-sample-service',
  /** Required: Sovereignty */
  sovereignty: 'eu',
  /** Required: Client configuration */
  config: {
    /** Required: Temando Account Id - should be set from 'account-id' header */
    accountId: '1aebd1fb-b587-45d4-8c69-d0f6064480f3',
    /** Required: Temando Code - should be set from 'code' header */
    code: 'cost centre code here',
    /**
     * Optional: Additional Default headers that get added to every request (in addition to 'account id', 'code',
     * 'x-temando-service-call' and 'x-temando-service-call-depth')
     */
    defaultHeaders: {
      'content-type': 'application/json',
    }
  }
});
```

### Add a service on the fly

This is useful for services or libraries that need to communicate with a service, but where it is not feasible to have that service
in its dependencies list.  An example of this would be completion service library, which needs to potentially communicate with every
carrier integration, however it is not practical to maintain a list of every possible carrier integration in its dependencies.

```javascript
const deployments = [
  {
    region: 'eu-west-1',
    endpoint: 'http://fake-endpoint',
    queues: [
      {
        id: 'ingest',
        url: 'https://fake-queue-addr',
      },
    ],
    topics: [
      { id: 'test-topic', arn: 'arn:aws:sns:test-region:293744123957:test-topic' },
    ],
    streams: [
      { id: 'test-stream', name: 'test-stream' },
    ],
  }
];
scf.registerService({ serviceName: 'my-service', currentRegion: 'eu-west-1', deployments })

const sampleClient = scf.create({
  name: 'my-service',
  sovereignty: 'eu',
  config: {
    accountId: '1aebd1fb-b587-45d4-8c69-d0f6064480f3',
    code: 'cost centre code here',
    defaultHeaders: {
      'content-type': 'application/json',
    }
  }
});
```

### Make a HTTP Request

```javascript
// Where a HTTP POST Request is being made
const result = await sampleClient.request('/users', {
  method: 'POST',
  headers: {
    'my-special-header': 'header value'
  },
  body: JSON.stringify({
    hello: 'world'
  })
});
```

### Send a message to a queue

```javascript
// Where a message is being sent to a named queue

const result = await sampleClient.queue('processing-shipments', {
  headers: {
    'my-special-header': 'header value'
  },
  body: JSON.stringify({
    hello: 'world'
  }),
  /** Optional: Delay in seconds before message is visible in queue (defaults to 0) */
  delaySeconds: 5,
  /** Optional: Message De-Duplication Id - Intended for FIFO Queues @see http://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/FIFO-queues.html */
  messageDeduplicationId: 'string',
  /** Optional: Message Group Id - Intended for FIFO Queues */
  messageGroupId: 'string',
});
```

### Send a message to an SNS Topic

```javascript
// Where a message is being sent to an SNS Topic

const result = await sampleClient.message('subscription-list', {
  headers: {
    'my-special-header': 'header value'
  },
  body: JSON.stringify({
    hello: 'world'
  }),
  /** Optional: Subject for use in Emails and other notification types that can use it */
  subject: 'Alert Notification',
  /** Optional: Message Structure @see http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/SNS.html#publish-property */
  messageStructure: 'json',
});
```

### Stream a record to a stream

```javascript
// Where a message is being sent to a stream
const result = await sampleClient.stream('logs', {
  headers: {
    'my-special-header': 'header value'
  },
  body: JSON.stringify({
    hello: 'world'
  }),
  /** Required: Determines which shard the message gets sent to  @see http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/Kinesis.html#putRecord-property */
  partitionKey: 'urgent',
  /**
   * Optional: Guarantees strictly increasing sequence numbers, for puts from the same client and to the same partition key.
   * @see http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/Kinesis.html#putRecord-property
   */
  sequenceNumber: '14353453465',
  /**
   * Optional: The hash value used to explicitly determine the shard the data record is assigned to by overriding the partition key hash.
   * @see http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/Kinesis.html#putRecord-property
   */
  explicitHashKey: 'e238afed83829ae0392c'
});
```

## Utilities

Service Client Factory ships with two utility functions that can be used to retrieve the service definition and service environment from `ts-definition.json` and `ts-env.json` files.  Additionally the library also now supports `YAML` format for these two files.

**NOTE:** Please be aware that for the time being the `@temando/service-registry-cli` ([Link](https://src.temando.io/service-registry/service-registry-cli)) package will not generate `YAML` files for you using the `registry service pull-env` command. We suggest you stick to using `JSON` format for the time being. This is also the case with `@temando/serverless-temando-registry` ([Link](https://src.temando.io/service-registry/serverless-temando-service-registry-plugin)) plugin.

To use add the following to your imports:

```javascript
import { getServiceDefinition, getServiceEnv } from '@temando/service-client-factory/utils';
```

### getServiceDefinition

```javascript
const definitions = getServiceDefinition(path);
```

Where `path` is a path to your `ts-definition.json` or `ts-definition.yml`.

### getServiceEnv

```javascript
const environment = getServiceEnv(path);
```

Where `path` is a path to your `ts-env.json` or `ts-env.yml`.
