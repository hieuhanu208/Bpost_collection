# Service Registry CLI

[![build status](https://src.temando.io/service-registry/service-registry-cli/badges/master/build.svg)](https://src.temando.io/service-registry/service-registry-cli/commits/master)

The Service Registry CLI provides the means to manipulate a [Service Registry](https://src.temando.io/service-registry/service-registry).

- [Prerequisites](#prerequisites)
- [Installation](#installation)
- [Usage](#usage)
- [Basic Service Registry Operations](#basic-service-registry-operations)
    - [Key/Value Store Operations](#keyvalue-store-operations)
        - [List Keys in the Key/Value Store](#list-keys-in-the-keyvalue-store)
        - [Add Key/Value Pairs to the Key/Value Store](#add-keyvalue-pairs-to-the-keyvalue-store)
        - [Retrieve Key/Value Pairs from the Key/Value Store](#retrieve-keyvalue-pairs-from-the-keyvalue-store)
    - [Service Catalog Operations](#service-catalog-operations)
        - [List Services Registered in the Service Catalog](#list-services-registered-in-the-service-catalog)
        - [Register Services in the Service Catalog](#register-services-in-the-service-catalog)
        - [Retrieve the Details of a Registered Service](#retrieve-the-details-of-a-registered-service)
- [Advanced Service Registry Operations](#advanced-service-registry-operations)
- [Contributing](#contributing)

## Prerequisites

Use of the Service Registry CLI requires you have deployed a service registry to your environment (AWS stage). For more information, see [Service Registry README](https://src.temando.io/service-registry/service-registry/blob/master/README.md). Note that the environment must be globally unique to AWS, something like `dev` is likely to be in use.

## Installation

The Service Registry CLI should be installed globally so that it is available in any service project.

To install the Service Registry CLI globally, run the following command:

```sh
$ npm install -g @temando/service-registry-cli
```

## Usage

The Service Registry CLI provides three commands:

- `registry catalog`
- `registry kv`
- `registry service`

To discover more about each command, use the `--help` argument, eg. `registry catalog --help` or continue reading this document.

## Basic Service Registry Operations

Service Registry CLI provides simple "get and set" functionality for the service registry.

### Key/Value Store Operations

Services can use process variables that are hard coded into a deployment.

A better way to handle variables is to store them in the service registry. For example, `process.env.timeout` could be stored in the key/value store as a key and updated at runtime using [k/v client](https://src.temando.io/service-registry/keyvalue-client) or service registry CLI.

**Note:**

  - All keys are accessible from all services, keep this in mind with sensitive information.
  - Namespacing keys represents best practise. For example, `project-name/debug-enabled`.

The following are available basic key/value store operations.

#### List Keys in the Key/Value Store

The `kv list` parameter is used to the list the keys stored in the key/value store.

To list the keys in the key/value store, run the following command:

```sh
$ registry kv list -e {environment}
```

`{environment}` is the AWS stage to which your service registry is deployed.

#### Add Key/Value Pairs to the Key/Value Store

The `kv set` parameter is used to add key/value pairs to the key/value store.

To add a key/value pair to the key/value store, run the following command:

```sh
$ registry kv set <key> <value> -e {environment}
```

`{environment}` is the AWS stage to which your service registry is deployed.

For example, to add the key/value pair `message: "Hello World"` to the key/value store in an environment called `teststage`, run the following command:

```sh
$ registry kv set message "Hello World" -e teststage
```

#### Retrieve Key/Value Pairs from the Key/Value Store

The `kv get` parameter is used to retrieve a key/value pair from the key/value store.

To retrieve a key/value pair from the key/value store, run the following command:

```sh
$ registry kv get <key> -e {environment}
```

`{environment}` is the AWS stage to which your service registry is deployed.

For example, to retrieve the value for the `message` key in an environment called `teststage`, run the following command:

```sh
$ registry kv get message -e teststage
Hello World
```

The output of the command is: `message: Hello World`

### Service Catalog Operations

The service catalog hold service definitions (including, for example, endpoint deployment information) that can be referenced by other services.

The service definition can define dependent services so that variables such as `process.env.INSTRUMENT_SERVICE_URL` become unnecessary. In this way, deployed services, their deployed dependencies, and the relationships between services for a given environment (AWS stage) can be dynamically maintained.

Projects define their own service definitions in a `ts-definition.json` or `ts-definition.yml` file (see [JSON example](resources/examples/ts-definition.json) [YAML example](resources/examples/ts-definition.yml)), the details of which are registered in the service catalog.

The following are available basic service catalog operations.

#### List Services Registered in the Service Catalog

The `catalog list` command is used to list the services registered in the service catalog.

To list the services registered in the service catalog, run the following command:

```sh
$ registry catalog list -e {environment}
```

`{environment}` is the AWS stage to which your service registry is deployed.

#### Search for Services Registered in the Service Catalog

The `catalog search` command is used to search for the services registered in the service catalog, based on service attributes. The search can be for any key with any value.

For example, to search for services that have attribute `hasFoo` = `true`, run the following command:

```sh
$ registry catalog search hasFoo=true -e {environment}
[
  "temando-integration-serviceX-id"
]
```
where `temando-integration-serviceX-id` has the following service definition:

```json
{
    "definition": {
        "id": "temando-integration-serviceX-id",
        ...
        "attributes": {
            "hasFoo": true,
        }
    },
    "deployments": [],
    "$schema": "http://service-registry.temando.com/schema/service-catalog-entry+v1#"
}
```

In another example, assume that some services have attributes `type` and `isInternational`. To search for services that have attribute `type` = `carrier-integration` and attribute `isInternational` = `true`, run the following command:

```sh
$ registry catalog search type=carrier-integration&isInternational=true -e {environment}
[
  "temando-integration-X-id",
  "temando-integration-Y-id"
]
```
where `temando-integration-X-id` and `temando-integration-Y-id` has service definitions that match the following:

```json
{
    "definition": {
        "id": "...",
        ...
        "attributes": {
            "type": "carrier-integration",
            "isInternational": true
        }
    }
}
```

`{environment}` is the AWS stage to which your service registry is deployed.

Currently only equal condition is supported, e.g. attribute that equals something.

#### Register Services in the Service Catalog

The `service register` command is used to register a service in the service catalog.

To register a service in the service catalog:

  1. Clone the project for the service to register in the catalog.
  2. Execute the following command in the project's root directory:

    ```sh
    $ registry service register -e {environment}
    ```

`{environment}` is the AWS stage to which your service registry is deployed.

For example, to register Quote Service into a service registry called `teststage`, run the following command:

```sh
$ cd .../quote-service
$ registry service register -e teststage
Registering "temando-quote" into "teststage"…
Creating initial entry for "temando-quote"…
Done.
```

#### Retrieve the Details of a Registered Service

The `catalog get` command is used to retrieve the details of a registered service.

To retrieve the details of a registered service, run the following command:

```sh
$ registry catalog get {service name} -e {environment}
```

`{environment}` is the AWS stage to which your service registry is deployed.

For example, to retrieve the details of the `temando-quote` service from the service registry stored in the `teststage` environment, run the following command:

```sh
$ registry catalog get temando-quote -e teststage
{
  "definition": {
    "id": "temando-quote",
    "$schema": "http://service-registry.temando.com/schema/service-definition+v1#",
    "kvs": [],
    "dependencies": [
      "temando-instrumentation-gateway"
    ],
    "publicQueues": []
  },
  "deployments": [],
  "$schema": "http://service-registry.temando.com/schema/service-catalog-entry+v1#"
}
```

## Advanced Service Registry Operations

For information on advanced Service Registry operations, see

  - [Creating A Service](resources/docs/CREATING-A-SERVICE-HOWTO.md), for information on creating a new service with a service definition that can be registered in the service registry.
  - [Using Dependent Services](resources/docs/USING-DEPENDENT-SERVICES-HOWTO.md), for information on making services depend on other services.
  - [Using the Registry](resources/docs/USING-THE-REGISTRY-HOWTO.md), for information on using the service registry in a service.

## Contributing

See the [Contributors Guide](CONTRIBUTING.md).
